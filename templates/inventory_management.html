{% load static %}
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سیستم انبارداری پیشرفته</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #388E3C;
            --accent-color: #2E7D32;
            --text-color: #2c3e50;
            --light-bg: #f9f9f9;
            --border-color: #ddd;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --input-bg: #f1f8e9;
            --blue-light: #e3f2fd;
            --blue-dark: #2196f3;
            --orange: #FF9800;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Vazirmatn', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa, #e8f5e9);
            min-height: 100vh;
            padding: 10px;
            color: var(--text-color);
            direction: rtl;
            font-size: 14px;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
            padding: 15px;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .header h1 {
            font-size: 1.5rem;
            color: var(--accent-color);
        }

        .inventory-tabs {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .inventory-tab {
            padding: 8px 12px;
            cursor: pointer;
            border: 1px solid transparent;
            margin-bottom: -1px;
            white-space: nowrap;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .inventory-tab.active {
            border-color: var(--border-color);
            border-bottom-color: white;
            border-radius: 5px 5px 0 0;
            background: white;
            color: var(--accent-color);
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .search-section {
            margin-bottom: 20px;
        }

        .search-container {
            position: relative;
        }

        .search-label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: #555;
            font-weight: bold;
        }

        .search-input {
            width: 100%;
            padding: 12px 45px 12px 12px;
            font-size: 1rem;
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            transition: all 0.3s;
            background: var(--input-bg);
        }

        .search-input:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 8px rgba(46, 125, 50, 0.3);
            outline: none;
        }

        .search-btn {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--primary-color);
            font-size: 18px;
            cursor: pointer;
        }

        .search-hint {
            margin-top: 5px;
            font-size: 0.8rem;
            color: #666;
        }

        .search-results {
            border: 1px solid var(--border-color);
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 8px;
            background: white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: none;
            z-index: 1000;
            position: absolute;
            width: 100%;
        }

        .search-result-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.2s;
        }

        .search-result-item:hover {
            background-color: var(--light-bg);
        }

        .count-form {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .radio-group {
            display: flex;
            gap: 15px;
            margin-top: 5px;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: normal;
            cursor: pointer;
        }

        .count-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 0.8rem;
            box-shadow: 0 0 5px rgba(0,0,0,0.05);
        }

        .count-table th {
            background-color: var(--secondary-color);
            color: white;
            padding: 10px;
            text-align: center;
        }

        .count-table td {
            padding: 8px;
            border: 1px solid var(--border-color);
            text-align: center;
        }

        .new-product-badge {
            background-color: var(--primary-color);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
        }

        .old-product-badge {
            background-color: var(--orange);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--primary-color), var(--accent-color));
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(45deg, var(--accent-color), var(--primary-color));
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .btn-back {
            background: #9e9e9e;
            color: white;
        }

        .btn-back:hover {
            background: #757575;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        .error-message {
            color: #d32f2f;
            background-color: #ffebee;
            padding: 12px;
            border-radius: 6px;
            margin: 12px 0;
            border-left: 4px solid #d32f2f;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .success-message {
            color: #2E7D32;
            background-color: #e8f5e9;
            padding: 12px;
            border-radius: 6px;
            margin: 12px 0;
            border-left: 4px solid #2E7D32;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .info-message {
            color: #1976d2;
            background-color: #e3f2fd;
            padding: 12px;
            border-radius: 6px;
            margin: 12px 0;
            border-left: 4px solid #1976d2;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 480px) {
            body {
                padding: 5px;
                font-size: 13px;
            }

            .container {
                padding: 10px;
                border-radius: 8px;
            }

            .header h1 {
                font-size: 1.3rem;
            }

            .inventory-tab {
                padding: 6px 10px;
                font-size: 0.8rem;
            }

            .count-form {
                padding: 10px;
            }

            .btn {
                padding: 8px 15px;
                font-size: 0.85rem;
            }
        }

        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 15px;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.8rem;
        }

        .count-history {
            margin-top: 10px;
            font-size: 0.8rem;
            color: #666;
            background: #f0f0f0;
            padding: 8px;
            border-radius: 4px;
        }

        .last-count-info {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 5px;
        }

        .last-count-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .invoice-info-item {
            margin-bottom: 10px;
            padding: 8px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }

        .selected-branches {
            margin-top: 10px;
        }

        .selected-branch {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 5px;
            background-color: #e9ecef;
            border-radius: 3px;
            margin-bottom: 5px;
        }

        .storage-info {
            margin-top: 5px;
            font-size: 0.8em;
            color: #6c757d;
}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>سیستم انبارداری پیشرفته</h1>
        </div>

<div class="inventory-tabs">
    <div class="inventory-tab active" data-tab="search">جستجوی فاکتور</div>
    <div class="inventory-tab" data-tab="branch">موجودی شعب</div>
    <div class="inventory-tab" data-tab="product">موجودی محصولات</div>
    <div class="inventory-tab" data-tab="transfer">انتقال بین شعب</div>
    <div class="inventory-tab" data-tab="count">انبارگردانی</div>
</div>        <!-- تب جستجوی فاکتور -->
        <div class="tab-content  active " id="search-tab">
            <h2>جستجوی فاکتور</h2>

            <div class="search-section">
                <div class="search-container">
                    <label class="search-label">جستجوی فاکتور:</label>
                    <input type="text" id="invoice-search" class="search-input" placeholder="شماره فاکتور، نام فروشنده یا نام خانوادگی...">
                    <button type="button" class="search-btn">
                        <i class="fas fa-search"></i>
                    </button>
                    <div id="invoice-search-results" class="search-results"></div>
                </div>
                <div class="search-hint">برای جستجو، حداقل 2 کاراکتر وارد کنید</div>
            </div>

            <div id="invoice-details" style="display: none;">
                <h3>مشخصات فاکتور</h3>
                <div id="invoice-info" class="count-form"></div>

                <h3>لیست کالاهای فاکتور</h3>
                <div class="table-container">
                    <table class="count-table">
                        <thead>
                            <tr>
                                <th>نام کالا</th>
                                <th>تعداد در فاکتور</th>
                                <th>محل انبار</th>
                                <th>تعداد انبار شده</th>
                                <th>عملیات</th>
                            </tr>
                        </thead>
                        <tbody id="invoice-items-list">
                            <!-- موارد فاکتور اینجا نمایش داده می‌شوند -->
                        </tbody>
                    </table>
                </div>

                <div id="storage-actions" class="actions" style="display: none;">
                    <button id="invoice-back-btn" class="btn btn-back">
                        <i class="fas fa-arrow-right"></i> بازگشت
                    </button>
                    <button id="invoice-submit-btn" class="btn btn-primary">
                        <i class="fas fa-save"></i> ثبت اطلاعات انبار
                    </button>
                </div>
            </div>
        </div>
        <!-- تب انبارگردانی -->
        <div class="tab-content" id="count-tab">
            <h2>انبارگردانی</h2>

            <div class="count-form">
                <div class="form-group">
                    <label for="count-branch">شعبه:</label>
                    <div class="search-container">
                        <input type="text" id="count-branch-search" class="search-input" placeholder="جستجوی شعبه...">
                        <button type="button" class="search-btn">
                            <i class="fas fa-search"></i>
                        </button>
                        <div id="branch-search-results" class="search-results"></div>
                    </div>
                    <input type="hidden" id="count-branch">
                    <div id="selected-branch" class="search-hint" style="display: none;"></div>
                </div>

                <div class="form-group">
                    <label for="count-product">نام کالا:</label>
                    <div class="search-container">
                        <input type="text" id="count-product" class="search-input" placeholder="جستجوی نام کالا...">
                        <button type="button" class="search-btn">
                            <i class="fas fa-search"></i>
                        </button>
                        <div id="product-search-results" class="search-results"></div>
                    </div>
                </div>

                <div id="product-type-container" style="display: none;">
                    <div class="form-group">
                        <label>نوع کالا:</label>
                        <div class="radio-group">
                            <label>
                                <input type="radio" id="product-type-new" name="product-type" value="new" checked>
                                کالای جدید
                            </label>
                            <label>
                                <input type="radio" id="product-type-old" name="product-type" value="old">
                                کالای قدیمی
                            </label>
                        </div>
                    </div>
                </div>

                <div id="product-history" class="count-history" style="display: none;">
                    <strong>تاریخچه آخرین شمارش:</strong>
                    <div id="last-count-info" class="last-count-info"></div>
                </div>

                <div class="form-group">
                    <label for="count-quantity">تعداد شمارش شده:</label>
                    <input type="number" id="count-quantity" class="form-control" min="0" value="0">
                </div>

                <button id="add-count-btn" class="btn btn-primary">
                    <i class="fas fa-plus"></i> افزودن به لیست
                </button>
            </div>

            <div id="count-list-container" style="display: none;">
                <h3>لیست کالاهای شمارش شده</h3>
                <div class="table-container">
                    <table class="count-table">
                        <thead>
                            <tr>
                                <th>نام کالا</th>
                                <th>شعبه</th>
                                <th>نوع</th>
                                <th>تعداد</th>
                                <th>عملیات</th>
                            </tr>
                        </thead>
                        <tbody id="count-list">
                            <!-- موارد شمارش شده اینجا نمایش داده می‌شوند -->
                        </tbody>
                    </table>
                </div>

                <div class="actions">
                    <button id="count-back-btn" class="btn btn-back">
                        <i class="fas fa-arrow-right"></i> بازگشت
                    </button>
                    <button id="count-submit-btn" class="btn btn-primary">
                        <i class="fas fa-save"></i> به روزرسانی انبار
                    </button>
                </div>
            </div>
        </div>

        <div id="messages"></div>
    </div>

{#    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>#}
    <script src="{% static 'js/jQueryv3.7.1.js' %}"></script>
    <script>
        // متغیرهای global برای مدیریت فاکتور
        let selectedInvoice = null;
        let invoiceItems = [];
        let storageEntries = [];
        let invoiceSearchTimeout = null;
        let branches = [];
        let isSubmitting = false;

        // بارگذاری اولیه لیست شعب
        function loadBranches() {
            $.ajax({
                url: "{% url 'get_branches' %}",
                method: 'GET',
                success: function(data) {
                    if (data.success) {
                        branches = data.branches;
                        console.log("Branches loaded:", branches.length);
                    }
                },
                error: function(xhr) {
                    showMessage('خطا در دریافت اطلاعات شعب', 'error');
                }
            });
        }

        // فراخوانی اولیه برای بارگذاری شعب
        loadBranches();

        // مدیریت تب‌ها
        $('.inventory-tab').click(function() {
            $('.inventory-tab').removeClass('active');
            $('.tab-content').removeClass('active');

            $(this).addClass('active');
            const tabId = $(this).data('tab');
            $(`#${tabId}-tab`).addClass('active');

            // اگر تب انبارگردانی انتخاب شد، مقادیر را ریست کنیم
            if (tabId === 'count') {
                resetCountForm();
            }
        });

        // جستجوی فاکتور
        $('#invoice-search').on('input', function() {
            const query = $(this).val().trim();

            if (query.length < 2) {
                $('#invoice-search-results').hide().empty();
                return;
            }

            clearTimeout(invoiceSearchTimeout);
            invoiceSearchTimeout = setTimeout(function() {
                $.ajax({
                    url: "{% url 'search_invoices' %}",
                    data: { q: query },
                    dataType: 'json',
                    success: function(data) {
                        console.log("Search results:", data);
                        if (data.results && data.results.length > 0) {
                            let html = '';
                            data.results.forEach(invoice => {
                                html += `
                                    <div class="search-result-item" data-invoice-id="${invoice.id}">
                                        <strong>${invoice.serial_number}</strong>
                                        <div>فروشنده: ${invoice.seller_name}</div>
                                        <div>تاریخ: ${invoice.date}</div>
                                    </div>
                                `;
                            });
                            $('#invoice-search-results').html(html).show();
                        } else {
                            $('#invoice-search-results').html('<div class="search-result-item">هیچ فاکتوری یافت نشد</div>').show();
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error in invoice search:', error);
                        showMessage('خطا در جستجوی فاکتورها', 'error');
                    }
                });
            }, 300);
        });

        // انتخاب فاکتور از نتایج جستجو
        $(document).on('click', '#invoice-search-results .search-result-item', function() {
            const invoiceId = $(this).data('invoice-id');
            const invoiceText = $(this).find('strong').text();
            $('#invoice-search').val(invoiceText);
            $('#invoice-search-results').hide();

            // دریافت جزئیات فاکتور
            $.ajax({
                url: "{% url 'get_invoice_details' %}",
                data: { invoice_id: invoiceId },
                dataType: 'json',
                success: function(data) {
                    console.log("Invoice details:", data);
                    if (data.success) {
                        selectedInvoice = data.invoice;
                        invoiceItems = data.items;
                        storageEntries = [];

                        // نمایش اطلاعات فاکتور
                        $('#invoice-info').html(`
                            <div class="invoice-info-item"><strong>شماره فاکتور:</strong> ${selectedInvoice.serial_number}</div>
                            <div class="invoice-info-item"><strong>فروشنده:</strong> ${selectedInvoice.seller_name}</div>
                            <div class="invoice-info-item"><strong>تاریخ:</strong> ${selectedInvoice.date}</div>
                        `);

                        // نمایش آیتم‌های فاکتور
                        updateInvoiceItemsList();

                        $('#invoice-details').show();
                        $('#storage-actions').show();
                    } else {
                        showMessage(data.error, 'error');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error getting invoice details:', error);
                    showMessage('خطا در دریافت اطلاعات فاکتور', 'error');
                }
            });
        });

        // به روزرسانی لیست آیتم‌های فاکتور
        function updateInvoiceItemsList() {
            const $itemsList = $('#invoice-items-list');
            $itemsList.empty();

            invoiceItems.forEach((item, index) => {
                const itemEntries = storageEntries.filter(entry => entry.item_index === index);
                const totalStored = itemEntries.reduce((sum, entry) => sum + parseInt(entry.quantity), 0);

                const row = `
                    <tr data-item-index="${index}">
                        <td>${item.product_name}</td>
                        <td>${item.remaining_quantity}</td>
                        <td>
                            <div class="search-container">
                                <input type="text" class="branch-search search-input" placeholder="جستجوی شعبه..." data-item-index="${index}">
                                <div class="branch-search-results search-results"></div>
                            </div>
                            <div class="selected-branches">
                                ${itemEntries.map(entry => `
                                    <div class="selected-branch">
                                        ${entry.branch_name} (${entry.quantity})
                                        <button type="button" class="btn btn-sm remove-storage-entry" data-entry-index="${entry.entry_index}">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        </td>
                        <td>
                            <input type="number" class="quantity-input" min="0" max="${item.remaining_quantity}" value="0" data-item-index="${index}">
                            <div class="storage-info">
                                <small>ذخیره شده: ${totalStored}</small>
                                <small>باقیمانده: ${item.remaining_quantity}</small>
                            </div>
                        </td>
                        <td>
                            <button class="btn btn-sm add-storage-entry" data-item-index="${index}">
                                <i class="fas fa-plus"></i> تایید
                            </button>
                        </td>
                    </tr>
                `;
                $itemsList.append(row);
            });

            if (storageEntries.length > 0) {
                $('#storage-actions').show();
            } else {
                $('#storage-actions').hide();
            }
        }

        // جستجوی شعبه برای آیتم‌های فاکتور
        $(document).on('input', '.branch-search', function() {
            const query = $(this).val().trim();
            const $results = $(this).siblings('.branch-search-results');

            if (query.length < 1) {
                $results.hide().empty();
                return;
            }

            const filteredBranches = branches.filter(branch =>
                branch.name.includes(query) || branch.address.includes(query)
            );

            if (filteredBranches.length === 0) {
                $results.html('<div class="search-result-item">هیچ شعبه‌ای یافت نشد</div>').show();
                return;
            }

            let html = '';
            filteredBranches.forEach(branch => {
                html += `
                    <div class="search-result-item" data-branch-id="${branch.id}" data-branch-name="${branch.name}">
                        <strong>${branch.name}</strong>
                        <div>${branch.address}</div>
                    </div>
                `;
            });

            $results.html(html).show();
        });

        // انتخاب شعبه از نتایج جستجو
        $(document).on('click', '.branch-search-results .search-result-item', function() {
            const branchId = $(this).data('branch-id');
            const branchName = $(this).data('branch-name');

            const $searchInput = $(this).closest('.search-container').find('.branch-search');
            $searchInput.val(branchName);
            $searchInput.data('branch-id', branchId);
            $(this).closest('.branch-search-results').hide();
        });

        // افزودن ورودی انبار برای یک آیتم
        $(document).on('click', '.add-storage-entry', function() {
            const itemIndex = $(this).data('item-index');
            const $row = $(`tr[data-item-index="${itemIndex}"]`);
            const branchName = $row.find('.branch-search').val().trim();
            const branchId = $row.find('.branch-search').data('branch-id');
            const quantity = parseInt($row.find('.quantity-input').val());

            if (!branchName || !branchId) {
                showMessage('لطفاً شعبه را انتخاب کنید', 'error');
                return;
            }

            if (quantity <= 0) {
                showMessage('لطفاً تعداد معتبر وارد کنید', 'error');
                return;
            }

            const branch = branches.find(b => b.id == branchId);
            if (!branch) {
                showMessage('شعبه انتخاب شده معتبر نیست', 'error');
                return;
            }

            const item = invoiceItems[itemIndex];
            const currentTotal = storageEntries
                .filter(entry => entry.item_index === itemIndex)
                .reduce((sum, entry) => sum + parseInt(entry.quantity), 0);

            if (currentTotal + quantity > item.quantity) {
                showMessage('تعداد وارد شده از مقدار فاکتور بیشتر است', 'error');
                return;
            }

            const entryIndex = storageEntries.length;
            storageEntries.push({
                entry_index: entryIndex,
                item_index: itemIndex,
                product_name: item.product_name,
                branch_id: branchId,
                branch_name: branchName,
                quantity: quantity
            });

            updateInvoiceItemsList();
            $row.find('.branch-search').val('');
            $row.find('.branch-search').removeData('branch-id');
            $row.find('.quantity-input').val(0);
        });

        // حذف ورودی انبار
        $(document).on('click', '.remove-storage-entry', function() {
            const entryIndex = $(this).data('entry-index');
            storageEntries = storageEntries.filter(entry => entry.entry_index !== entryIndex);
            updateInvoiceItemsList();
        });

        // ثبت نهایی اطلاعات انبار
        $('#invoice-submit-btn').click(function() {
            if (isSubmitting) {
                showMessage('در حال پردازش درخواست قبلی... لطفاً صبر کنید', 'info');
                return false;
            }

            if (storageEntries.length === 0) {
                showMessage('هیچ اطلاعاتی برای ثبت وجود ندارد', 'error');
                return;
            }

            if (!confirm('آیا از ثبت اطلاعات انبار مطمئن هستید؟')) {
                return;
            }

            // غیرفعال کردن دکمه و تغییر متن آن
            isSubmitting = true;
            $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> در حال ثبت...');

            // ایجاد شناسه یکتا برای این درخواست
            const requestId = Date.now().toString() + Math.random().toString(36).substr(2, 9);

            showMessage('در حال ثبت اطلاعات...', 'info');

            // ارسال داده‌ها به سرور برای ثبت انبار
            $.ajax({
                url: "{% url 'store_invoice_items' %}",
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    items: storageEntries,
                    invoice_id: selectedInvoice.id,
                    request_id: requestId
                }),
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                success: function(data) {
                    if (data.success) {
                        showMessage(data.message, 'success');

                        // پس از موفقیت آمیز بودن ثبت انبار، قیمت‌گذاری محصولات را به روز کنید
                        $.ajax({
                            url: "{% url 'update_product_pricing' %}",
                            method: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify({
                                invoice_id: selectedInvoice.id
                            }),
                            headers: {
                                'X-CSRFToken': getCookie('csrftoken')
                            },
                            success: function(pricingData) {
                                if (pricingData.success) {
                                    console.log('قیمت‌گذاری محصولات به روز شد');
                                } else {
                                    console.error('خطا در به‌روزرسانی قیمت‌گذاری:', pricingData.error);
                                }
                            },
                            error: function(xhr) {
                                console.error('خطا در به‌روزرسانی قیمت‌گذاری محصولات');
                            }
                        });

                        // هدایت به صفحه چاپ
                        if (data.print_url) {
                            window.open(data.print_url, '_blank');
                        }

                        // پاکسازی فرم و بازگشت به صفحه اصلی بعد از 2 ثانیه
                        setTimeout(() => {
                            window.location.href = "{% url 'home' %}";
                        }, 2000);
                    } else {
                        showMessage(data.error, 'error');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error storing invoice items:', error);
                    showMessage('خطا در ثبت اطلاعات', 'error');
                },
                complete: function() {
                    // فعال کردن دکمه و بازگرداندن متن اصلی
                    isSubmitting = false;
                    $('#invoice-submit-btn').prop('disabled', false).html('<i class="fas fa-save"></i> ثبت اطلاعات انبار');
                }
            });
        });

        // بازگشت از صفحه فاکتور
        $('#invoice-back-btn').click(function() {
            if (storageEntries.length > 0) {
                if (!confirm('تغییرات ذخیره نشده از بین خواهند رفت. آیا مطمئن هستید؟')) {
                    return;
                }
            }

            window.location.href = "{% url 'home' %}";
        });

        // تابع برای دریافت cookie
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // تابع برای نمایش پیام
        function showMessage(message, type) {
            const messageClass = type === 'error' ? 'error-message' :
                                type === 'success' ? 'success-message' : 'info-message';
            const icon = type === 'error' ? 'fa-exclamation-circle' :
                        type === 'success' ? 'fa-check-circle' : 'fa-info-circle';

            $('#messages').html(`
                <div class="${messageClass}">
                    <i class="fas ${icon}"></i> ${message}
                </div>
            `);

            if (type !== 'error') {
                setTimeout(() => {
                    $('#messages').empty();
                }, 5000);
            }
        }

        // مخفی کردن نتایج جستجو هنگام کلیک خارج
        $(document).on('click', function(e) {
            if (!$(e.target).closest('.search-container').length) {
                $('.search-results').hide();
            }
        });

        
        
        
        // مدیریت تب انبارگردانی
let countItems = [];
let currentProductType = 'new';
let searchTimeout = null;

function resetCountForm() {
    $('#count-product').val('');
    $('#count-quantity').val('0');
    $('#product-type-container').hide();
    $('#product-search-results').hide().empty();
    $('#product-history').hide();
    $('#product-type-new').prop('checked', true);
    currentProductType = 'new';
    $('#selected-branch').hide();
}

// جستجوی شعب برای انبارگردانی
$('#count-branch-search').on('input', function() {
    const query = $(this).val().trim();
    
    if (query.length < 2) {
        $('#branch-search-results').hide().empty();
        return;
    }
    
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(function() {
        $.ajax({
            url: "{% url 'search_branches_count' %}",
            data: { q: query },
            dataType: 'json',
            success: function(data) {
                if (data.results && data.results.length > 0) {
                    let html = '';
                    data.results.forEach(branch => {
                        html += `
                            <div class="search-result-item" data-branch-id="${branch.id}" data-branch-name="${branch.name}">
                                <strong>${branch.name}</strong>
                                <div>${branch.address}</div>
                            </div>
                        `;
                    });
                    $('#branch-search-results').html(html).show();
                } else {
                    $('#branch-search-results').html('<div class="search-result-item">هیچ شعبه‌ای یافت نشد</div>').show();
                }
            },
            error: function(xhr, status, error) {
                console.error('Error in branch search:', error);
                showMessage('خطا در جستجوی شعب', 'error');
            }
        });
    }, 300);
});

// انتخاب شعبه از نتایج
$(document).on('click', '#branch-search-results .search-result-item', function() {
    const branchId = $(this).data('branch-id');
    const branchName = $(this).data('branch-name');
    
    $('#count-branch-search').val(branchName);
    $('#count-branch').val(branchId);
    $('#selected-branch').html(`شعبه انتخاب شده: <strong>${branchName}</strong>`).show();
    $('#branch-search-results').hide();
    
    // پاک کردن فیلد محصول وقتی شعبه تغییر می‌کند
    $('#count-product').val('');
    $('#product-history').hide();
});

// جستجوی محصولات برای انبارگردانی
$('#count-product').on('input', function() {
    const query = $(this).val().trim();
    const branchId = $('#count-branch').val();
    
    if (!branchId) {
        showMessage('لطفاً ابتدا شعبه را انتخاب کنید', 'error');
        return;
    }
    
    if (query.length < 2) {
        $('#product-search-results').hide().empty();
        return;
    }
    
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(function() {
        $.ajax({
            url: "{% url 'search_products_count' %}",
            data: { 
                q: query,
                branch_id: branchId
            },
            dataType: 'json',
            success: function(data) {
                if (data.results && data.results.length > 0) {
                    let html = '';
                    data.results.forEach(product => {
                        html += `
                            <div class="search-result-item" 
                                 data-product-id="${product.id}"
                                 data-product-name="${product.product_name}"
                                 data-branch-id="${product.branch_id}"
                                 data-current-quantity="${product.current_quantity}">
                                <strong>${product.product_name}</strong>
                                <div>شعبه: ${product.branch_name} - موجودی فعلی: ${product.current_quantity}</div>
                                <div>آخرین شمارش: ${product.last_count_date} توسط ${product.last_counter}</div>
                            </div>
                        `;
                    });
                    $('#product-search-results').html(html).show();
                } else {
                    $('#product-search-results').html('<div class="search-result-item">هیچ محصولی یافت نشد</div>').show();
                }
            },
            error: function(xhr, status, error) {
                console.error('Error in product search:', error);
                showMessage('خطا در جستجوی محصولات', 'error');
            }
        });
    }, 300);
});

// انتخاب محصول از نتایج
$(document).on('click', '#product-search-results .search-result-item', function() {
    const productName = $(this).data('product-name');
    const branchId = $(this).data('branch-id');
    const currentQuantity = $(this).data('current-quantity');
    
    $('#count-product').val(productName);
    $('#product-search-results').hide();
    
    // نمایش اطلاعات محصول انتخاب شده
    $.ajax({
        url: "{% url 'get_product_details' %}",
        data: { 
            product_name: productName,
            branch_id: branchId
        },
        dataType: 'json',
        success: function(data) {
            let historyHtml = '';
            
            if (data.exists) {
                historyHtml += `
                    <div class="last-count-item">
                        <i class="fas fa-box"></i>
                        <span>موجودی فعلی: <strong>${data.current_quantity}</strong></span>
                    </div>
                    <div class="last-count-item">
                        <i class="fas fa-user"></i>
                        <span>آخرین شمارنده: <strong>${data.last_counter}</strong></span>
                    </div>
                    <div class="last-count-item">
                        <i class="fas fa-calendar"></i>
                        <span>تاریخ آخرین شمارش: <strong>${data.last_count_date}</strong></span>
                    </div>
                `;
                
                if (data.last_counts && data.last_counts.length > 0) {
                    historyHtml += `<div style="margin-top: 10px; border-top: 1px solid #ddd; padding-top: 5px;">`;
                    historyHtml += `<strong>تاریخچه شمارش‌ها:</strong>`;
                    data.last_counts.forEach(count => {
                        historyHtml += `
                            <div style="font-size: 0.7rem; margin-top: 3px;">
                                ${count.count_date}: ${count.quantity} عدد (${count.counter__username || 'نامشخص'})
                            </div>
                        `;
                    });
                    historyHtml += `</div>`;
                }
            } else {
                historyHtml = '<div>این محصول برای اولین بار در این شعبه شمارش می‌شود</div>';
            }
            
            $('#last-count-info').html(historyHtml);
            $('#product-history').show();
        },
        error: function(xhr, status, error) {
            console.error('Error getting product details:', error);
            $('#last-count-info').html('<div>خطا در دریافت اطلاعات محصول</div>');
            $('#product-history').show();
        }
    });
});

// افزودن به لیست شمارش
$('#add-count-btn').click(function() {
    const productName = $('#count-product').val().trim();
    const branchId = $('#count-branch').val();
    const branchName = $('#count-branch-search').val();
    const quantity = parseInt($('#count-quantity').val());
    
    if (!productName) {
        showMessage('لطفاً محصول را انتخاب کنید', 'error');
        return;
    }
    
    if (!branchId) {
        showMessage('لطفاً شعبه را انتخاب کنید', 'error');
        return;
    }
    
    if (isNaN(quantity) || quantity < 0) {
        showMessage('لطفاً تعداد معتبر وارد کنید', 'error');
        return;
    }
    
    // اضافه کردن به لیست
    const itemId = Date.now().toString();
    countItems.push({
        id: itemId,
        productName: productName,
        branchId: branchId,
        branchName: branchName,
        quantity: quantity,
        productType: currentProductType
    });
    
    updateCountList();
    
    // پاک کردن فرم
    $('#count-product').val('');
    $('#count-quantity').val('0');
    $('#product-history').hide();
    
    showMessage('محصول به لیست اضافه شد', 'success');
});

// به روزرسانی لیست شمارش
function updateCountList() {
    const $countList = $('#count-list');
    $countList.empty();
    
    countItems.forEach((item, index) => {
        const row = `
            <tr data-item-id="${item.id}">
                <td>${item.productName}</td>
                <td>${item.branchName}</td>
                <td>${item.productType === 'new' ? 'جدید' : 'قدیمی'}</td>
                <td>${item.quantity}</td>
                <td>
                    <button class="btn btn-sm remove-count-item" data-item-id="${item.id}">
                        <i class="fas fa-times"></i> حذف
                    </button>
                </td>
            </tr>
        `;
        $countList.append(row);
    });
    
    if (countItems.length > 0) {
        $('#count-list-container').show();
    } else {
        $('#count-list-container').hide();
    }
}

// حذف از لیست شمارش
$(document).on('click', '.remove-count-item', function() {
    const itemId = $(this).data('item-id');
    countItems = countItems.filter(item => item.id !== itemId);
    updateCountList();
});

// ثبت نهایی انبارگردانی
$('#count-submit-btn').click(function() {
    if (countItems.length === 0) {
        showMessage('هیچ محصولی برای ثبت وجود ندارد', 'error');
        return;
    }
    
    if (!confirm('آیا از ثبت انبارگردانی مطمئن هستید؟')) {
        return;
    }
    
    // غیرفعال کردن دکمه
    $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> در حال ثبت...');
    
    $.ajax({
        url: "{% url 'update_inventory_count' %}",
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            items: countItems
        }),
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        success: function(data) {
            if (data.success) {
                showMessage(data.message, 'success');
                // پاکسازی فرم بعد از ثبت موفق
                countItems = [];
                resetCountForm();
                $('#count-list-container').hide();
                
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                showMessage(data.error, 'error');
            }
        },
        error: function(xhr, status, error) {
            console.error('Error updating inventory:', error);
            showMessage('خطا در ثبت انبارگردانی', 'error');
        },
        complete: function() {
            $('#count-submit-btn').prop('disabled', false).html('<i class="fas fa-save"></i> به روزرسانی انبار');
        }
    });
});

// بازگشت از انبارگردانی
$('#count-back-btn').click(function() {
    if (countItems.length > 0) {
        if (!confirm('تغییرات ذخیره نشده از بین خواهند رفت. آیا مطمئن هستید؟')) {
            return;
        }
    }
    resetCountForm();
    $('#count-list-container').hide();
});
    </script>
</body>
</html>




