
{% load static %}
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سیستم صدور فاکتور فروش</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css">
    <style>
        :root {
            --primary-color: #2E7D32;
            --secondary-color: #388E3C;
            --accent-color: #1B5E20;
            --success-color: #4CAF50;
            --warning-color: #FF9800;
            --danger-color: #F44336;
            --text-color: #2c3e50;
            --light-bg: #f9f9f9;
            --border-color: #ddd;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --input-bg: #f1f8e9;
            --gradient-primary: linear-gradient(135deg, #2E7D32, #4CAF50);
            --gradient-success: linear-gradient(135deg, #4CAF50, #66BB6A);
            --gradient-warning: linear-gradient(135deg, #FF9800, #FFB74D);
            --gradient-danger: linear-gradient(135deg, #F44336, #EF5350);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Vazirmatn', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa, #e8f5e9);
            min-height: 100vh;
            padding: 10px;
            color: var(--text-color);
            direction: rtl;
            font-size: 14px;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .header h1 {
            font-size: 1.5rem;
            color: var(--accent-color);
            font-weight: 700;
        }

        .branch-info {
            background: var(--gradient-primary);
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(46, 125, 50, 0.3);
        }

        .section-card {
            background: white;
            border-radius: 10px;
            padding: 18px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid var(--border-color);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .section-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }

        .section-title {
            font-size: 1.1rem;
            color: var(--accent-color);
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e8f5e9;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .search-container {
            position: relative;
            margin-bottom: 15px;
        }

        .search-input {
            width: 100%;
            padding: 12px 45px 12px 12px;
            font-size: 1rem;
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            transition: all 0.3s;
            background: var(--input-bg);
        }

        .search-input:focus {
            box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
            border-color: var(--accent-color);
        }

        .search-results {
            border: 1px solid var(--border-color);
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 5px;
            background: white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: none;
            z-index: 1000;
            position: absolute;
            width: 100%;
        }

        .search-result-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.2s;
        }

        .search-result-item:hover {
            background-color: var(--light-bg);
        }

        .low-stock {
            background-color: #ffebee !important;
            color: #d32f2f !important;
        }

        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 0.9rem;
            border-radius: 8px;
            overflow: hidden;
        }

        .invoice-table th {
            background: var(--gradient-primary);
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: 600;
        }

        .invoice-table td {
            padding: 12px;
            border: 1px solid var(--border-color);
            text-align: center;
            transition: background 0.2s;
        }

        .invoice-table tr:hover td {
            background-color: #f8f9fa;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--gradient-success);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(46, 125, 50, 0.3);
        }

        .btn-success {
            background: var(--gradient-success);
            color: white;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #66BB6A, #81C784);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .btn-warning {
            background: var(--gradient-warning);
            color: white;
        }

        .btn-warning:hover {
            background: linear-gradient(135deg, #FFB74D, #FFCC80);
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--gradient-danger);
            color: white;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #EF5350, #E57373);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #78909c;
            color: white;
        }

        .btn-secondary:hover {
            background: #546e7a;
            transform: translateY(-2px);
        }

        .btn-outline-primary {
            background: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
        }

        .btn-outline-primary:hover {
            background: var(--primary-color);
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.8rem;
            border-radius: 20px;
        }

        .summary-card {
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            border: 2px solid var(--success-color);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.2);
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px dashed #bdbdbd;
            font-size: 0.95rem;
        }

        .summary-total {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--accent-color);
            margin-top: 10px;
        }

        .modal-content {
            border-radius: 12px;
            border: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .modal-header {
            background: var(--gradient-primary);
            color: white;
            border-bottom: none;
            padding: 15px 20px;
        }

        .modal-title {
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.9rem;
            color: var(--text-color);
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.9rem;
            transition: all 0.3s;
            background: white;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
            outline: none;
        }

        .form-control-sm {
            padding: 6px 10px;
            font-size: 0.85rem;
        }

        .payment-method-btn {
            width: 100%;
            padding: 15px;
            margin: 5px 0;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            text-align: right;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
        }

        .payment-method-btn:hover {
            border-color: var(--primary-color);
            background: #f1f8e9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .payment-method-btn.active {
            border-color: var(--accent-color);
            background: #e8f5e9;
            box-shadow: 0 2px 6px rgba(46, 125, 50, 0.2);
        }

        .discount-input {
            max-width: 200px;
        }

        .date-picker-container {
            position: relative;
        }

        .date-picker-container .form-control {
            padding-left: 40px;
        }

        .date-picker-icon {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary-color);
            cursor: pointer;
            font-size: 1.1rem;
        }

        .device-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .device-card:hover {
            border-color: var(--primary-color);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .device-card .card-body {
            padding: 12px;
        }

        .badge {
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 12px;
        }

        .bg-success {
            background: var(--success-color) !important;
        }

        .toast-container {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            z-index: 9999;
        }

        .toast {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-left: 4px solid var(--primary-color);
            margin-bottom: 10px;
            animation: slideIn 0.3s ease-out;
        }

        .toast.success {
            border-left-color: var(--success-color);
        }

        .toast.error {
            border-left-color: var(--danger-color);
        }

        .toast.warning {
            border-left-color: var(--warning-color);
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-card {
            animation: fadeIn 0.5s ease-out;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .action-buttons .btn {
            flex: 1;
            min-width: 120px;
        }

        .form-text {
            font-size: 0.8rem;
            color: #78909c;
            margin-top: 4px;
        }

        .text-muted {
            color: #78909c !important;
        }

        .border {
            border: 1px solid var(--border-color) !important;
        }

        .rounded {
            border-radius: 8px !important;
        }

        .table-responsive {
            border-radius: 8px;
            overflow: hidden;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .btn {
                padding: 8px 15px;
                font-size: 0.85rem;
            }
            
            .invoice-table {
                font-size: 0.8rem;
            }
            
            .invoice-table th,
            .invoice-table td {
                padding: 8px 5px;
            }
            
            .section-card {
                padding: 12px;
            }
            
            .payment-method-btn {
                padding: 12px;
                font-size: 0.85rem;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .action-buttons .btn {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-receipt"></i> سیستم صدور فاکتور فروش</h1>
        </div>

        {% if not branch_selected %}
        <!-- فرم انتخاب شعبه -->
        <div class="section-card">
            <h2 class="section-title"><i class="fas fa-store"></i> انتخاب شعبه</h2>
            <form method="post">
                {% csrf_token %}
                <div class="form-group">
                    <label for="id_branch">شعبه:</label>
                    {{ form.branch }}
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-check"></i> تایید شعبه
                </button>
            </form>
        </div>
        {% else %}
        <!-- صفحه اصلی فاکتور -->
        <div class="branch-info">
            <i class="fas fa-store"></i> شعبه: {{ branch.name }} | 
            <i class="fas fa-user"></i> کاربر: {{ user.get_full_name|default:user.username }}
        </div>

        <!-- دکمه مدیریت دستگاه‌های پوز -->
        <div class="section-card">
            <h3 class="section-title"><i class="fas fa-pos-terminal"></i> مدیریت دستگاه‌های پرداخت</h3>
            <div class="row">
                <div class="col-md-6">
                    <button type="button" class="btn btn-primary w-100 mb-2" data-bs-toggle="modal" data-bs-target="#posDeviceModal">
                        <i class="fas fa-plus-circle"></i> افزودن دستگاه پوز جدید
                    </button>
                </div>
                <div class="col-md-6">
                    <button type="button" class="btn btn-outline-primary w-100 mb-2" onclick="showAllPOSDevices()">
                        <i class="fas fa-list"></i> مشاهده دستگاه‌های موجود
                    </button>
                </div>
            </div>
            
            <!-- نمایش دستگاه پیش‌فرض -->
            {% if default_pos %}
            <div class="alert alert-info mt-2">
                <strong><i class="fas fa-star"></i> دستگاه پیش‌فرض:</strong>
                {{ default_pos.name }} - {{ default_pos.bank_name }}
            </div>
            {% endif %}
        </div>

        <!-- فیلدهای اطلاعات خریدار و تاریخ -->
        <div class="section-card">
            <h3 class="section-title"><i class="fas fa-user"></i> اطلاعات فاکتور</h3>
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="customer-name">نام خریدار:</label>
                        <input type="text" id="customer-name" class="form-control" value="{{ customer_name }}" placeholder="نام خریدار">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="customer-phone">تلفن خریدار:</label>
                        <input type="text" id="customer-phone" class="form-control" value="{{ customer_phone }}" placeholder="تلفن خریدار">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="invoice-date">تاریخ فاکتور:</label>
                        <div class="date-picker-container">
                            <i class="fas fa-calendar-alt date-picker-icon" onclick="openDatePicker()"></i>
                            <input type="text" id="invoice-date" class="form-control" readonly>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- بخش روش پرداخت -->
        <div class="section-card">
            <h3 class="section-title"><i class="fas fa-credit-card"></i> روش پرداخت</h3>
            <div class="row">
                <div class="col-md-3">
                    <button type="button" class="payment-method-btn {% if payment_method == 'pos' %}active{% endif %}" data-method="pos">
                        <i class="fas fa-pos-terminal"></i>
                        <span>
                            دستگاه پوز
                            {% if default_pos %}
                            <br><small>{{ default_pos.name }}</small>
                            {% endif %}
                        </span>
                    </button>
                </div>
                <div class="col-md-3">
                    <button type="button" class="payment-method-btn {% if payment_method == 'cash' %}active{% endif %}" data-method="cash">
                        <i class="fas fa-money-bill-wave"></i>
                        <span>نقدی</span>
                    </button>
                </div>
                <div class="col-md-3">
                    <button type="button" class="payment-method-btn {% if payment_method == 'check' %}active{% endif %}" data-method="check">
                        <i class="fas fa-money-check"></i>
                        <span>چک</span>
                    </button>
                </div>
                <div class="col-md-3">
                    <button type="button" class="payment-method-btn {% if payment_method == 'credit' %}active{% endif %}" data-method="credit">
                        <i class="fas fa-calendar-day"></i>
                        <span>نسیه</span>
                    </button>
                </div>
            </div>

            <!-- بخش دستگاه‌های پوز -->
            <div id="pos-devices-section" class="mt-3" style="display: {% if payment_method == 'pos' %}block{% else %}none{% endif %};">
                <div class="form-group">
                    <label for="pos-device">انتخاب دستگاه پوز:</label>
                    <select id="pos-device" class="form-control">
                        {% for device in pos_devices %}
                            <option value="{{ device.id }}" {% if default_pos and device.id == default_pos.id %}selected{% endif %}>
                                {{ device.name }} - {{ device.bank_name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <!-- بخش جستجو و افزودن کالا -->
        <div class="section-card">
            <h3 class="section-title"><i class="fas fa-search"></i> جستجو و افزودن کالا</h3>
            <div class="search-container">
                <input type="text" id="product-search" class="search-input" placeholder="نام یا بارکد کالا را وارد کنید...">
                <div id="search-results" class="search-results"></div>
            </div>
            <small class="text-muted">برای جستجو، حداقل 2 کاراکتر وارد کنید</small>
        </div>

        <!-- لیست کالاهای فاکتور -->
        <div class="section-card">
            <h3 class="section-title"><i class="fas fa-list"></i> لیست کالاهای فاکتور</h3>
            <div class="table-responsive">
                <table class="invoice-table">
                    <thead>
                        <tr>
                            <th>نام کالا</th>
                            <th>تعداد</th>
                            <th>قیمت واحد</th>
                            <th>تخفیف آیتم</th>
                            <th>قیمت کل</th>
                            <th>عملیات</th>
                        </tr>
                    </thead>
                    <tbody id="invoice-items-list">
                        {% for item in items %}
                        <tr id="item-{{ item.product_id }}">
                            <td>{{ item.product_name }}</td>
                            <td>
                                <input type="number" class="form-control form-control-sm quantity-input" 
                                       value="{{ item.quantity }}" min="1" 
                                       data-product-id="{{ item.product_id }}" 
                                       style="width: 80px; display: inline-block;">
                            </td>
                            <td>{{ item.price|floatformat:"0" }} تومان</td>
                            <td>
                                <input type="number" class="form-control form-control-sm discount-input" 
                                       value="{{ item.discount|default:0 }}" min="0" 
                                       data-product-id="{{ item.product_id }}"
                                       style="width: 100px; display: inline-block;">
                            </td>
                            <td>{{ item.total|floatformat:"0" }} تومان</td>
                            <td>
                                <button class="btn btn-danger btn-sm" onclick="removeItem({{ item.product_id }})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- خلاصه فاکتور و تخفیف -->
        <div class="section-card summary-card">
            <h3 class="section-title"><i class="fas fa-calculator"></i> خلاصه فاکتور</h3>
            <div class="row">
                <div class="col-md-6">
                    <div class="summary-item">
                        <span>تعداد آیتم‌ها:</span>
                        <span id="total-items">{{ items|length }}</span>
                    </div>
                    <div class="summary-item">
                        <span>جمع کل بدون تخفیف:</span>
                        <span id="total-without-discount">0 تومان</span>
                    </div>
                    <div class="summary-item">
                        <span>تخفیف آیتم‌ها:</span>
                        <span id="items-discount">0 تومان</span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="total-discount">تخفیف کل فاکتور (تومان):</label>
                        <input type="number" id="total-discount" class="form-control discount-input" 
                               value="{{ discount }}" min="0" style="max-width: 200px;">
                    </div>
                    <div class="summary-item summary-total">
                        <span>مبلغ قابل پرداخت:</span>
                        <span id="total-amount">{{ total_amount|floatformat:"0" }} تومان</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- دکمه‌های اقدام -->
        <div class="section-card">
            <div class="action-buttons">
                <button type="button" class="btn btn-danger" onclick="cancelInvoice()">
                    <i class="fas fa-times"></i> انصراف و لغو فاکتور
                </button>
                <div class="d-flex" style="gap: 10px;">
                    <button type="button" class="btn btn-secondary" onclick="finalizeInvoice('save_only')">
                        <i class="fas fa-save"></i> ثبت فاکتور
                    </button>
{#                    <button type="button" class="btn btn-success" onclick="finalizeInvoice('print_and_save')">#}
{#                        <i class="fas fa-print"></i> ثبت و چاپ فاکتور#}
{#                    </button>#}
                </div>
            </div>
        </div>

        <!-- سیستم پیام‌ها -->
        <div id="toast-container" class="toast-container"></div>
        {% endif %}
    </div>

    <!-- مودال دستگاه پوز -->
    <div class="modal fade" id="posDeviceModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-pos-terminal"></i> مدیریت دستگاه‌های پوز</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- فرم افزودن دستگاه جدید -->
                    <div class="mb-4">
                        <h6><i class="fas fa-plus-circle"></i> افزودن دستگاه جدید:</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="device-name" class="form-label">نام دستگاه *</label>
                                    <input type="text" class="form-control" id="device-name" placeholder="مثال: پوز بانک ملت" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="account-holder" class="form-label">نام صاحب حساب *</label>
                                    <input type="text" class="form-control" id="account-holder" placeholder="نام کامل صاحب حساب" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="card-number" class="form-label">شماره کارت *</label>
                                    <input type="text" class="form-control" id="card-number" maxlength="16" placeholder="16 رقم شماره کارت" required>
                                    <small class="form-text text-muted">شماره کارت باید 16 رقم باشد</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="account-number" class="form-label">شماره حساب *</label>
                                    <input type="text" class="form-control" id="account-number" placeholder="شماره حساب بانکی" required>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="bank-name" class="form-label">نام بانک *</label>
                            <input type="text" class="form-control" id="bank-name" placeholder="مثال: بانک ملت" required>
                        </div>
                    </div>

                    <hr>

                    <!-- لیست دستگاه‌های موجود -->
                    <h6><i class="fas fa-list"></i> دستگاه‌های موجود:</h6>
                    <div id="pos-devices-list" class="mb-3">
                        {% for device in pos_devices %}
                        <div class="card device-card">
                            <div class="card-body py-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>{{ device.name }}</strong> - {{ device.bank_name }}
                                        {% if device.is_default %}
                                            <span class="badge bg-success me-2"><i class="fas fa-star"></i> پیش فرض</span>
                                        {% endif %}
                                        <br>
                                        <small class="text-muted">
                                            <i class="fas fa-credit-card"></i> شماره کارت: {{ device.card_number }} | 
                                            <i class="fas fa-user"></i> صاحب حساب: {{ device.account_holder }}
                                        </small>
                                    </div>
                                    <div>
                                        {% if not device.is_default %}
                                        <button class="btn btn-sm btn-outline-success me-1 set-default-btn" 
                                                data-device-id="{{ device.id }}" title="تنظیم پیش‌فرض">
                                            <i class="fas fa-star"></i>
                                        </button>
                                        {% endif %}
                                        <button class="btn btn-sm btn-outline-danger delete-device-btn" 
                                                data-device-id="{{ device.id }}" title="حذف دستگاه">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center text-muted p-3 border rounded">
                            <i class="fas fa-info-circle fa-2x mb-2"></i>
                            <p>هیچ دستگاهی ثبت نشده است</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> بستن
                    </button>
                    <button type="button" class="btn btn-success" id="addDeviceButton">
                        <i class="fas fa-plus-circle"></i> افزودن دستگاه جدید
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال پرداخت چک -->
    <div class="modal fade" id="checkPaymentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-money-check"></i> اطلاعات پرداخت چک</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="check-payment-form">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>نام صاحب چک:</label>
                                    <input type="text" name="owner_name" class="form-control" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>نام خانوادگی صاحب چک:</label>
                                    <input type="text" name="owner_family" class="form-control" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>کد ملی:</label>
                                    <input type="text" name="national_id" class="form-control" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>تلفن:</label>
                                    <input type="text" name="phone" class="form-control" required>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>آدرس:</label>
                            <textarea name="address" class="form-control" rows="3"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>شماره چک:</label>
                                    <input type="text" name="check_number" class="form-control" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>مبلغ چک (تومان):</label>
                                    <input type="number" name="amount" class="form-control" required>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>تاریخ چک:</label>
                            <div class="date-picker-container">
                                <i class="fas fa-calendar-alt date-picker-icon" onclick="openCheckDatePicker()"></i>
                                <input type="text" name="check_date" class="form-control" id="check-date" readonly required>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button>
                    <button type="button" class="btn btn-primary" onclick="saveCheckPayment()">ذخیره اطلاعات چک</button>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال پرداخت نسیه -->
    <div class="modal fade" id="creditPaymentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-calendar-day"></i> اطلاعات پرداخت نسیه</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="credit-payment-form">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>نام:</label>
                                    <input type="text" name="customer_name" class="form-control" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>نام خانوادگی:</label>
                                    <input type="text" name="customer_family" class="form-control" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>تلفن:</label>
                                    <input type="text" name="phone" class="form-control" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>کد ملی:</label>
                                    <input type="text" name="national_id" class="form-control" required>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>آدرس:</label>
                            <textarea name="address" class="form-control" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label>تاریخ سررسید:</label>
                            <div class="date-picker-container">
                                <i class="fas fa-calendar-alt date-picker-icon" onclick="openDueDatePicker()"></i>
                                <input type="text" name="due_date" class="form-control" id="due-date" readonly required>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button>
                    <button type="button" class="btn btn-primary" onclick="saveCreditPayment()">ذخیره اطلاعات نسیه</button>
                </div>
            </div>
        </div>
    </div>

    <!-- اسکریپت‌ها -->
    <script src="{% static 'js/jQueryv3.7.1.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/persian-date@1.1.0/dist/persian-date.min.js"></script>
    <script src="https://unpkg.com/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>
    
    <script>
// متغیرهای global
let currentPaymentMethod = '{{ payment_method }}';
let searchTimeout = null;
let invoiceDatePicker, checkDatePicker, dueDatePicker;

// متغیرهای جهانی برای مدیریت بارکد
let barcodeBuffer = "";
let barcodeTimeout = null;
const BARCODE_DELAY = 150;
let lastBarcodeTime = 0;


// تابع محاسبه جمع کل فاکتور
function calculateInvoiceTotal() {
    let totalItems = 0;
    let totalWithoutDiscount = 0;
    let itemsDiscount = 0;
    let totalAmount = 0;

    // محاسبه از روی جدول آیتم‌ها
    $('#invoice-items-list tr').each(function() {
        // اگر ردیف واقعی کالا باشد (دارای input باشد)
        if ($(this).find('.quantity-input').length > 0) {
            const quantity = parseInt($(this).find('.quantity-input').val()) || 0;
            
            // قیمت را از data attribute بگیریم (مطمئن‌تر)
            const price = parseFloat($(this).find('.quantity-input').data('price')) || 0;
            
            const discount = parseInt($(this).find('.discount-input').val()) || 0;
            
            totalItems += quantity;
            totalWithoutDiscount += quantity * price;
            itemsDiscount += discount;
        }
    });

    // محاسبه تخفیف کل
    const totalDiscount = parseInt($('#total-discount').val()) || 0;

    // محاسبه مبلغ نهایی
    totalAmount = totalWithoutDiscount - itemsDiscount - totalDiscount;

    // به روزرسانی خلاصه فاکتور
    $('#total-items').text(totalItems);
    $('#total-without-discount').text(totalWithoutDiscount.toLocaleString('fa-IR') + ' تومان');
    $('#items-discount').text(itemsDiscount.toLocaleString('fa-IR') + ' تومان');
    $('#total-amount').text(Math.max(0, totalAmount).toLocaleString('fa-IR') + ' تومان');

    return {
        totalItems,
        totalWithoutDiscount,
        itemsDiscount,
        totalDiscount,
        totalAmount
    };
}

// تابع به روزرسانی مبلغ هر ردیف - اصلاح شده
function updateItemRowTotal(productId) {
    const row = $(`#item-${productId}`);
    if (row.length === 0) return;
    
    const quantityInput = row.find('.quantity-input');
    const quantity = parseInt(quantityInput.val()) || 0;
    
    // قیمت را از data attribute بگیریم (مطمئن‌تر از استخراج از متن)
    const price = parseFloat(quantityInput.data('price')) || 0;
    
    const discount = parseInt(row.find('.discount-input').val()) || 0;
    
    const total = (quantity * price) - discount;
    
    // به روزرسانی سلول مبلغ کل (سلول پنجم)
    row.find('td').eq(4).text(total.toLocaleString('fa-IR') + ' تومان');
    
    // به روزرسانی خلاصه فاکتور
    calculateInvoiceTotal();
}


// تابع برای نمایش همه دستگاه‌ها
function showAllPOSDevices() {
    if ($('#pos-devices-list .card').length > 0) {
        $('#posDeviceModal').modal('show');
    } else {
        showToast('هیچ دستگاه پوزی ثبت نشده است. لطفا ابتدا یک دستگاه اضافه کنید.', 'warning');
    }
}

// وقتی صفحه کاملاً بارگذاری شد
$(document).ready(function() {
    // فعال‌سازی سیستم اسکن بارکد
    setupBarcodeScanner();
    
    // مقداردهی اولیه تاریخ‌ها
    initializeDatePickers();
    
    // فوکوس روی فیلد جستجو هنگام بارگذاری صفحه
    setTimeout(function() {
        $('#product-search').focus();
    }, 500);
    
    // محاسبه اولیه جمع فاکتور
    calculateInvoiceTotal();
    
    // رویداد کلیک برای دکمه افزودن دستگاه
    $('#addDeviceButton').on('click', function(e) {
        e.preventDefault();
        addPosDevice();
    });

    // رویداد برای دکمه‌های حذف دستگاه
    $(document).on('click', '.delete-device-btn', function() {
        const deviceId = $(this).data('device-id');
        const deviceName = $(this).closest('.card').find('strong').text();
        
        if (confirm(`آیا از حذف دستگاه "${deviceName}" اطمینان دارید؟`)) {
            deletePosDevice(deviceId);
        }
    });

    // رویداد برای دکمه‌های تنظیم پیش‌فرض
    $(document).on('click', '.set-default-btn', function() {
        const deviceId = $(this).data('device-id');
        const deviceName = $(this).closest('.card').find('strong').text();
        
        if (confirm(`آیا می‌خواهید دستگاه "${deviceName}" را به عنوان پیش‌فرض تنظیم کنید؟`)) {
            setDefaultPosDevice(deviceId);
        }
    });

    // وقتی مودال باز می‌شود
    $('#posDeviceModal').on('shown.bs.modal', function () {
        $('#device-name').focus();
    });

    // تنظیم event listeners دیگر
    setupEventListeners();
});

// تابع مقداردهی تقویم‌های شمسی
function initializeDatePickers() {
    // تاریخ فاکتور
    invoiceDatePicker = $('#invoice-date').persianDatepicker({
        format: 'YYYY/MM/DD',
        initialValue: true,
        initialValueType: 'persian',
        autoClose: true,
        observer: true,
        position: 'auto'
    });

    // تاریخ چک
    checkDatePicker = $('#check-date').persianDatepicker({
        format: 'YYYY/MM/DD',
        initialValue: true,
        initialValueType: 'persian',
        autoClose: true,
        observer: true,
        position: 'auto'
    });

    // تاریخ سررسید نسیه
    dueDatePicker = $('#due-date').persianDatepicker({
        format: 'YYYY/MM/DD',
        initialValue: false,
        initialValueType: 'persian',
        autoClose: true,
        observer: true,
        position: 'auto'
    });
}

// توابع باز کردن تقویم
function openDatePicker() {
    invoiceDatePicker.persianDatepicker('show');
}

function openCheckDatePicker() {
    checkDatePicker.persianDatepicker('show');
}

function openDueDatePicker() {
    dueDatePicker.persianDatepicker('show');
}

// تابع حذف دستگاه
function deletePosDevice(deviceId) {
    $.ajax({
        url: "{% url 'invoice_app:manage_pos_devices' %}",
        method: 'POST',
        data: {
            'action': 'delete',
            'device_id': deviceId
        },
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        success: function(data) {
            if (data.status === 'success') {
                showToast('دستگاه با موفقیت حذف شد', 'success');
                location.reload();
            } else {
                showToast('خطا در حذف دستگاه: ' + (data.message || 'خطای ناشناخته'), 'error');
            }
        },
        error: function(xhr, status, error) {
            showToast('خطا در ارتباط با سرور', 'error');
        }
    });
}

// تابع تنظیم دستگاه پیش‌فرض
function setDefaultPosDevice(deviceId) {
    $.ajax({
        url: "{% url 'invoice_app:manage_pos_devices' %}",
        method: 'POST',
        data: {
            'action': 'set_default',
            'device_id': deviceId
        },
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        success: function(data) {
            if (data.status === 'success') {
                showToast('دستگاه پیش‌فرض با موفقیت تغییر کرد', 'success');
                location.reload();
            } else {
                showToast('خطا در تغییر دستگاه پیش‌فرض: ' + (data.message || 'خطای ناشناخته'), 'error');
            }
        },
        error: function(xhr, status, error) {
            showToast('خطا در ارتباط با سرور', 'error');
        }
    });
}

// تنظیم event listeners
// تابع تنظیم event listeners - به‌روزرسانی شده
function setupEventListeners() {
        // در تابع setupEventListeners، این قسمت را اصلاح کنید:
    $(document).on('click', '.search-result-item', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const productId = $(this).data('product-id');
        console.log('کالای انتخاب شده - ID:', productId);
        
        addToInvoice(productId);
        $('#product-search').val('');
        $('#search-results').hide();
    });
    // جستجوی محصول
    $('#product-search').on('input', function() {
        clearTimeout(searchTimeout);
        const query = $(this).val().trim();
        
        if (query.length < 2) {
            $('#search-results').hide().empty();
            return;
        }
        
        searchTimeout = setTimeout(() => searchProduct(query), 300);
    });

    // تغییر تعداد محصول
    $(document).on('change', '.quantity-input', function() {
        const productId = $(this).data('product-id');
        const newQuantity = parseInt($(this).val());
        
        if (newQuantity < 1) {
            $(this).val(1);
            showToast('تعداد نمی‌تواند کمتر از ۱ باشد', 'warning');
            return;
        }
        
        updateItemRowTotal(productId);
        updateItemQuantity(productId, newQuantity);
    });

    // تغییر real-time در تعداد محصول
    $(document).on('input', '.quantity-input', function() {
        const productId = $(this).data('product-id');
        const newQuantity = parseInt($(this).val()) || 0;
        
        if (newQuantity >= 1) {
            updateItemRowTotal(productId);
        }
    });

    // تغییر تخفیف آیتم
    $(document).on('change', '.discount-input', function() {
        const productId = $(this).data('product-id');
        const discount = parseInt($(this).val()) || 0;
        
        if (discount < 0) {
            $(this).val(0);
            showToast('تخفیف نمی‌تواند منفی باشد', 'warning');
            return;
        }
        
        updateItemRowTotal(productId);
        updateItemDiscount(productId, discount);
    });

    // تغییر real-time در تخفیف آیتم
    $(document).on('input', '.discount-input', function() {
        const productId = $(this).data('product-id');
        const discount = parseInt($(this).val()) || 0;
        
        if (discount >= 0) {
            updateItemRowTotal(productId);
        }
    });

    // تغییرات real-time در تخفیف کل
    $('#total-discount').on('input', function() {
        const discount = parseInt($(this).val()) || 0;
        if (discount >= 0) {
            calculateInvoiceTotal();
        }
    });

    // ذخیره اطلاعات خریدار
    $('#customer-name, #customer-phone').on('blur', saveCustomerInfo);

    // انتخاب روش پرداخت - به‌روزرسانی شده
    $('.payment-method-btn').click(function() {
        const method = $(this).data('method');
        currentPaymentMethod = method;
        
        $('.payment-method-btn').removeClass('active');
        $(this).addClass('active');
        
        $('#pos-devices-section').toggle(method === 'pos');
        
        if (method === 'check') {
            $('#checkPaymentModal').modal('show');
        } else if (method === 'credit') {
            $('#creditPaymentModal').modal('show');
        }
        
        savePaymentMethod(method);
        
        // ذخیره دستگاه POS اگر انتخاب شده است
        if (method === 'pos') {
            setTimeout(saveSelectedPosDevice, 100);
        }
    });

    // تغییر دستگاه POS
    $('#pos-device').on('change', saveSelectedPosDevice);

    // رویداد کلیک برای نتایج جستجو
    $(document).on('click', '.search-result-item', function() {
        const productId = $(this).data('product-id');
        addToInvoice(productId);
        $('#product-search').val('');
        $('#search-results').hide();
    });

    // جلوگیری از ارسال فرم با Enter
    $('input').on('keydown', function(e) {
        if (e.keyCode === 13) {
            e.preventDefault();
            return false;
        }
    });
}
// تنظیم سیستم اسکن بارکد
function setupBarcodeScanner() {
    // رویداد keydown برای تشخیص Enter بارکدخوان
    $('#product-search').on('keydown', function(e) {
        const currentTime = new Date().getTime();
        
        if (e.key === 'Enter' || e.keyCode === 13) {
            e.preventDefault();
            
            if (barcodeBuffer.length >= 6) {
                processBarcodeScan(barcodeBuffer);
            }
            
            barcodeBuffer = "";
            $(this).val('');
            return;
        }
        
        if (e.key.length === 1 && e.key !== ' ' && e.key !== 'Enter') {
            if (currentTime - lastBarcodeTime < BARCODE_DELAY) {
                barcodeBuffer += e.key;
            } else {
                barcodeBuffer = e.key;
            }
            
            lastBarcodeTime = currentTime;
            
            clearTimeout(barcodeTimeout);
            barcodeTimeout = setTimeout(function() {
                if (barcodeBuffer.length >= 8 && /^\d+$/.test(barcodeBuffer)) {
                    processBarcodeScan(barcodeBuffer);
                    barcodeBuffer = "";
                    $('#product-search').val('');
                }
            }, BARCODE_DELAY + 50);
        }
    });
    
    // رویداد input برای حالت دوم تشخیص
    $('#product-search').on('input', function(e) {
        const value = $(this).val().trim();
        
        if (value.length >= 8 && /^\d+$/.test(value)) {
            clearTimeout(barcodeTimeout);
            
            barcodeTimeout = setTimeout(() => {
                processBarcodeScan(value);
                $(this).val('');
            }, 300);
        }
    });
}

// پردازش اسکن بارکد
function processBarcodeScan(barcode) {
    showToast('در حال جستجوی کالا...', 'info');
    
    $.ajax({
        url: "{% url 'invoice_app:invoice_search_product' %}",
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            query: barcode,
            is_barcode: true
        }),
        headers: {'X-CSRFToken': getCookie('csrftoken')},
        success: function(data) {
            if (data.error) {
                showToast('خطا در جستجو: ' + data.error, 'error');
                return;
            }
            
            if (!data.results || data.results.length === 0) {
                showToast('کالایی با این بارکد یافت نشد', 'warning');
                $('#product-search').val('').focus();
                return;
            }
            
            if (data.results.length === 1) {
                const product = data.results[0];
                
                if (product.quantity <= 0) {
                    if (confirm(`کالای "${product.name}" موجودی صفر دارد. آیا می‌خواهید ادامه دهید؟`)) {
                        addToInvoice(product.id, 1, true);
                    } else {
                        $('#product-search').val('').focus();
                    }
                } else {
                    addToInvoice(product.id, 1, true);
                }
                
            } else {
                showToast('چند کالا یافت شد. لطفا انتخاب کنید', 'info');
                displaySearchResults(data.results);
            }
        },
        error: function(xhr, status, error) {
            showToast('خطا در ارتباط با سرور', 'error');
            $('#product-search').val('').focus();
        }
    });
}

// تابع برای افزودن به فاکتور
function addToInvoice(productId, quantity = 1, isAutoAdd = false) {
    console.log('📦 در حال افزودن کالا به فاکتور - ProductID:', productId, 'تعداد:', quantity);
    $.ajax({
        url: "{% url 'invoice_app:invoice_add_item' %}",
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            product_id: productId,
            quantity: quantity,
            is_auto_add: isAutoAdd
        }),
        headers: {'X-CSRFToken': getCookie('csrftoken')},
        success: function(data) {
            if (data.status === 'success') {
                updateInvoiceTable(data.items);
                
                if (isAutoAdd) {
                    showToast('کالا به طور خودکار اضافه شد ✓', 'success');
                } else {
                    showToast('کالا با موفقیت اضافه شد', 'success');
                }
                
                $('#product-search').val('').focus();
                $('#search-results').hide();
                
            } else if (data.status === 'error') {
                if (data.message.includes('موجودی کافی نیست')) {
                    if (confirm(data.message + '\n\nآیا می‌خواهید ادامه دهید؟')) {
                        forceAddToInvoice(productId, quantity);
                    } else {
                        $('#product-search').val('').focus();
                    }
                } else {
                    showToast(data.message, 'error');
                    $('#product-search').val('').focus();
                }
            }
        },
        error: function(xhr, status, error) {
            showToast('خطا در ارتباط با سرور', 'error');
            $('#product-search').val('').focus();
        }
    });
}

// تابع به روزرسانی جدول آیتم‌ها - اصلاح شده
function updateInvoiceTable(items) {
    const tbody = $('#invoice-items-list');
    tbody.empty();
    
    if (items.length === 0) {
        tbody.append('<tr><td colspan="6" class="text-center text-muted py-3">هیچ کالایی در فاکتور وجود ندارد</td></tr>');
        calculateInvoiceTotal();
        return;
    }
    
    items.forEach(item => {
        const totalAmount = (item.quantity * item.price) - (item.discount || 0);
        
        const row = `
            <tr id="item-${item.product_id}">
                <td>${item.product_name}</td>
                <td>
                    <input type="number" class="form-control form-control-sm quantity-input" 
                           value="${item.quantity}" min="1" 
                           data-product-id="${item.product_id}" 
                           data-price="${item.price}"
                           style="width: 80px; display: inline-block;">
                </td>
                <td>${item.price.toLocaleString('fa-IR')} تومان</td>
                <td>
                    <input type="number" class="form-control form-control-sm discount-input" 
                           value="${item.discount || 0}" min="0" 
                           data-product-id="${item.product_id}"
                           style="width: 100px; display: inline-block;">
                </td>
                <td>${totalAmount.toLocaleString('fa-IR')} تومان</td>
                <td>
                    <button class="btn btn-danger btn-sm" onclick="removeItem(${item.product_id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
        tbody.append(row);
    });

    calculateInvoiceTotal();
}

// تابع نمایش نتایج جستجو
function displaySearchResults(results) {
    const container = $('#search-results');
    container.empty();
    
    results.forEach((product) => {
        const stockStatus = product.quantity <= 0 ? 
            '<span class="badge bg-danger">موجودی صفر</span>' : 
            `<span class="badge bg-success">موجودی: ${product.quantity}</span>`;
        
        const item = $(`
            <div class="search-result-item" data-product-id="${product.id}">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${product.name}</strong>
                        <div class="text-muted small">قیمت: ${product.price.toLocaleString('fa-IR')}</div>
                    </div>
                    ${stockStatus}
                </div>
                ${product.barcode ? `<div class="small text-muted">بارکد: ${product.barcode}</div>` : ''}
            </div>
        `);
        
        container.append(item);
    });
    
    container.show();
}

// تابع برای افزودن اجباری
function forceAddToInvoice(productId, quantity = 1) {
    $.ajax({
        url: "{% url 'invoice_app:invoice_add_item' %}",
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            product_id: productId,
            quantity: quantity,
            ignore_stock: true
        }),
        headers: {'X-CSRFToken': getCookie('csrftoken')},
        success: function(data) {
            if (data.status === 'success') {
                updateInvoiceTable(data.items);
                showToast('کالا با موفقیت اضافه شد (با وجود محدودیت موجودی)', 'warning');
                $('#product-search').val('').focus();
            }
        },
        error: function() {
            showToast('خطا در افزودن کالا', 'error');
        }
    });
}

// تابع به روزرسانی تعداد آیتم
function updateItemQuantity(productId, quantity) {
    $.ajax({
        url: "{% url 'invoice_app:update_item_quantity' %}",
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({product_id: productId, quantity: quantity}),
        headers: {'X-CSRFToken': getCookie('csrftoken')},
        success: function(data) {
            if (data.status === 'success') {
                showToast('تعداد به روز شد', 'success');
            }
        },
        error: function() {
            showToast('خطا در به روزرسانی تعداد', 'error');
        }
    });
}

// تابع به روزرسانی تخفیف آیتم
function updateItemDiscount(productId, discount) {
    $.ajax({
        url: "{% url 'invoice_app:update_item_discount' %}",
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({product_id: productId, discount: discount}),
        headers: {'X-CSRFToken': getCookie('csrftoken')},
        success: function(data) {
            if (data.status === 'success') {
                showToast('تخفیف به روز شد', 'success');
            }
        },
        error: function() {
            showToast('خطا در به روزرسانی تخفیف', 'error');
        }
    });
}

// تابع حذف آیتم
function removeItem(productId) {
    if (!confirm('آیا از حذف این کالا اطمینان دارید؟')) return;
    
    $.ajax({
        url: "{% url 'invoice_app:invoice_remove_item' %}",
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({product_id: productId}),
        headers: {'X-CSRFToken': getCookie('csrftoken')},
        success: function(data) {
            if (data.status === 'success') {
                updateInvoiceTable(data.items);
                showToast('کالا حذف شد', 'success');
            }
        },
        error: function() {
            showToast('خطا در حذف کالا', 'error');
        }
    });
}

// تابع ذخیره تخفیف کل
function saveDiscount(discount) {
    $.ajax({
        url: "{% url 'invoice_app:save_discount' %}",
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({discount: discount}),
        headers: {'X-CSRFToken': getCookie('csrftoken')},
        success: function(data) {
            if (data.status === 'success') {
                showToast('تخفیف کل ذخیره شد', 'success');
            }
        },
        error: function() {
            showToast('خطا در ذخیره تخفیف', 'error');
        }
    });
}

// تابع جستجوی محصول
function searchProduct(query) {
    $.ajax({
        url: "{% url 'invoice_app:invoice_search_product' %}",
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({query: query}),
        headers: {'X-CSRFToken': getCookie('csrftoken')},
        success: function(data) {
            displaySearchResults(data.results);
        },
        error: function() {
            showToast('خطا در جستجوی محصول', 'error');
        }
    });
}

// توابع پرداخت چک
function saveCheckPayment() {
    const formData = {
        'owner_name': $('input[name="owner_name"]').val(),
        'owner_family': $('input[name="owner_family"]').val(),
        'national_id': $('input[name="national_id"]').val(),
        'phone': $('input[name="phone"]').val(),
        'address': $('textarea[name="address"]').val(),
        'check_number': $('input[name="check_number"]').val(),
        'amount': $('input[name="amount"]').val(),
        'check_date': $('input[name="check_date"]').val()
    };

    if (!formData.owner_name || !formData.owner_family || !formData.national_id || 
        !formData.phone || !formData.check_number || !formData.amount || !formData.check_date) {
        showToast('لطفا تمام فیلدهای ضروری را پر کنید', 'error');
        return;
    }

    $.ajax({
        url: "{% url 'invoice_app:save_check_payment' %}",
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        headers: {'X-CSRFToken': getCookie('csrftoken')},
        success: function(data) {
            if (data.status === 'success') {
                showToast('اطلاعات چک با موفقیت ذخیره شد', 'success');
                $('#checkPaymentModal').modal('hide');
            } else {
                showToast('خطا در ذخیره اطلاعات چک', 'error');
            }
        },
        error: function() {
            showToast('خطا در ارتباط با سرور', 'error');
        }
    });
}

// توابع پرداخت نسیه
function saveCreditPayment() {
    const formData = {
        'customer_name': $('input[name="customer_name"]').val(),
        'customer_family': $('input[name="customer_family"]').val(),
        'phone': $('input[name="phone"]').val(),
        'national_id': $('input[name="national_id"]').val(),
        'address': $('textarea[name="address"]').val(),
        'due_date': $('input[name="due_date"]').val()
    };

    if (!formData.customer_name || !formData.customer_family || !formData.phone || 
        !formData.national_id || !formData.due_date) {
        showToast('لطفا تمام فیلدهای ضروری را پر کنید', 'error');
        return;
    }

    $.ajax({
        url: "{% url 'invoice_app:save_credit_payment' %}",
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        headers: {'X-CSRFToken': getCookie('csrftoken')},
        success: function(data) {
            if (data.status === 'success') {
                showToast('اطلاعات نسیه با موفقیت ذخیره شد', 'success');
                $('#creditPaymentModal').modal('hide');
            } else {
                showToast('خطا در ذخیره اطلاعات نسیه', 'error');
            }
        },
        error: function() {
            showToast('خطا در ارتباط با سرور', 'error');
        }
    });
}

function saveCustomerInfo() {
    const name = $('#customer-name').val();
    const phone = $('#customer-phone').val();
    
    $.ajax({
        url: "{% url 'invoice_app:save_customer_info' %}",
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({customer_name: name, customer_phone: phone}),
        headers: {'X-CSRFToken': getCookie('csrftoken')},
        success: function(data) {
            if (data.status === 'success') {
                showToast('اطلاعات مشتری ذخیره شد', 'success');
            }
        },
        error: function() {
            showToast('خطا در ذخیره اطلاعات مشتری', 'error');
        }
    });
}


// تابع نهایی کردن فاکتور - کاملاً بازنویسی شده
// اصلاح بخش ارسال درخواست - داده‌ها باید به این صورت باشند
function finalizeInvoice(action) {
    // ابتدا validateInvoiceBeforeSubmit را فراخوانی کنید
    if (!validateInvoiceBeforeSubmit()) {
        return;
    }
    
    // ذخیره دستگاه POS اگر انتخاب شده
    if (currentPaymentMethod === 'pos') {
        if (!saveSelectedPosDevice()) {
            return;
        }
    }
    
    $.ajax({
        url: "{% url 'invoice_app:finalize_invoice' %}",
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({}), // داده خالی - session استفاده می‌کنید
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        success: function(data) {
            // پردازش پاسخ
        },
        error: function(xhr, status, error) {
            console.log('خطا در ارسال درخواست:', error);
            showToast('خطا در ارتباط با سرور', 'error');
        }
    });
}

function cancelInvoice() {
    if (confirm('آیا از انصراف اطمینان دارید؟ تمام تغییرات از بین خواهد رفت.')) {
        window.location.href = "{% url 'invoice_app:invoice_cancel' %}";
    }
}


// تابع نمایش پیام
function showToast(message, type = 'info') {
    const toast = $(`
        <div class="toast ${type}">
            <div class="toast-body">
                <div class="d-flex justify-content-between align-items-center">
                    <span>${message}</span>
                    <button type="button" class="btn-close" onclick="$(this).closest('.toast').remove()"></button>
                </div>
            </div>
        </div>
    `);
    
    $('#toast-container').append(toast);
    
    setTimeout(() => {
        toast.fadeOut(300, function() {
            $(this).remove();
        });
    }, 3000);
}

// اضافه کردن توابع به محیط global
window.addPosDevice = addPosDevice;
window.calculateInvoiceTotal = calculateInvoiceTotal;
window.updateItemRowTotal = updateItemRowTotal;
window.addPosDevice = addPosDevice;
window.calculateInvoiceTotal = calculateInvoiceTotal;
window.updateItemRowTotal = updateItemRowTotal;
window.finalizeInvoice = finalizeInvoice;
window.cancelInvoice = cancelInvoice;
window.removeItem = removeItem;
window.openDatePicker = openDatePicker;
window.openCheckDatePicker = openCheckDatePicker;
window.openDueDatePicker = openDueDatePicker;
window.saveCheckPayment = saveCheckPayment;
window.saveCreditPayment = saveCreditPayment;
window.showAllPOSDevices = showAllPOSDevices;

// تابع مقداردهی اولیه صفحه - اضافه شده
function initializePage() {
    // پاک‌سازی session هنگام بارگذاری صفحه
    clearInvoiceSession();
    
    // فعال‌سازی سیستم اسکن بارکد
    setupBarcodeScanner();
    
    // مقداردهی اولیه تاریخ‌ها
    initializeDatePickers();
    
    // فوکوس روی فیلد جستجو
    setTimeout(function() {
        $('#product-search').focus();
    }, 500);
    
    // محاسبه اولیه جمع فاکتور
    calculateInvoiceTotal();
    
    // تنظیم event listeners
    setupEventListeners();
}

// تابع پاک‌سازی session فاکتور - اضافه شده
function clearInvoiceSession() {
    $.ajax({
        url: "{% url 'invoice_app:invoice_cancel' %}",
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        success: function(data) {
            console.log('Session فاکتور قبلی پاک شد');
        },
        error: function(xhr, status, error) {
            console.log('خطا در پاک‌سازی session:', error);
        }
    });
}
// رفع مشکل دکمه‌های ثبت فاکتور - اضافه کردن event listener مستقیم
$(document).ready(function() {
    console.log("📝 اسکریپت بارگذاری شد - بررسی دکمه‌ها");
    
    // بررسی وجود دکمه‌ها
    const saveButton = $('button:contains("ثبت فاکتور")');
    const printButton = $('button:contains("ثبت و چاپ فاکتور")');
    const cancelButton = $('button:contains("انصراف و لغو فاکتور")');
    
    console.log("دکمه ثبت فاکتور یافت شد:", saveButton.length > 0);
    console.log("دکمه ثبت و چاپ یافت شد:", printButton.length > 0);
    console.log("دکمه انصراف یافت شد:", cancelButton.length > 0);
    
    // حذف event listenerهای قدیمی و اضافه کردن جدید
    $('button').off('click'); // حذف کلیک‌های قبلی
    
    // اضافه کردن event listener جدید برای دکمه ثبت فاکتور
    $(document).on('click', 'button:contains("ثبت فاکتور")', function(e) {
        e.preventDefault();
        console.log("🟢 دکمه 'ثبت فاکتور' کلیک شد");
        finalizeInvoice('save_only');
    });
    
    // اضافه کردن event listener برای دکمه ثبت و چاپ
    $(document).on('click', 'button:contains("ثبت و چاپ فاکتور")', function(e) {
        e.preventDefault();
        console.log("🟢 دکمه 'ثبت و چاپ فاکتور' کلیک شد");
        finalizeInvoice('print_and_save');
    });
    
    // اضافه کردن event listener برای دکمه انصراف
    $(document).on('click', 'button:contains("انصراف و لغو فاکتور")', function(e) {
        e.preventDefault();
        console.log("🟢 دکمه 'انصراف' کلیک شد");
        cancelInvoice();
    });
});

// تعریف مجدد توابع به صورت global برای اطمینان
window.finalizeInvoice = function(action) {
    console.log("🔴 finalizeInvoice فراخوانی شد با action:", action);
    
    // 1. بررسی وجود آیتم در فاکتور
    const items = $('#invoice-items-list tr');
    const hasRealItems = items.length > 0 && 
                        !(items.length === 1 && items.find('td').hasClass('text-muted'));
    
    if (!hasRealItems) {
        showToast('فاکتور باید حداقل یک آیتم داشته باشد', 'error');
        console.log("❌ فاکتور خالی است");
        return;
    }
    
    // 2. بررسی روش پرداخت
    if (!currentPaymentMethod) {
        showToast('لطفا روش پرداخت را انتخاب کنید', 'error');
        console.log("❌ روش پرداخت انتخاب نشده");
        return;
    }
    
    // 3. بررسی اطلاعات پرداخت خاص
    if (currentPaymentMethod === 'check') {
        if (!confirm('آیا اطلاعات چک را وارد کرده‌اید؟')) {
            $('#checkPaymentModal').modal('show');
            console.log("📋 نمایش مودال چک");
            return;
        }
    }
    
    if (currentPaymentMethod === 'credit') {
        if (!confirm('آیا اطلاعات نسیه را وارد کرده‌اید؟')) {
            $('#creditPaymentModal').modal('show');
            console.log("📋 نمایش مودال نسیه");
            return;
        }
    }
    
    // 4. تأیید نهایی کاربر
    const message = action === 'print_and_save' 
        ? 'آیا از ثبت و چاپ فاکتور اطمینان دارید؟'
        : 'آیا از ثبت فاکتور اطمینان دارید؟';
    
    if (!confirm(message)) {
        console.log("❌ کاربر انصراف داد");
        return;
    }
    
    console.log("🟡 تمام validationها passed شد");
    
    // 5. غیرفعال کردن دکمه‌ها
    $('.btn-success, .btn-secondary').prop('disabled', true);
    showToast('در حال ثبت فاکتور... لطفا منتظر بمانید', 'info');
    
    // 6. ارسال درخواست AJAX - این بخش حیاتی است!
    $.ajax({
        url: "{% url 'invoice_app:finalize_invoice' %}",
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            action: action,
            payment_method: currentPaymentMethod,
            timestamp: new Date().getTime() // برای جلوگیری از cache
        }),
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        success: function(data) {
            console.log("✅ پاسخ سرور دریافت شد:", data);
            
            if (data.status === 'success') {
                showToast('فاکتور با موفقیت ثبت شد', 'success');
                console.log("🎉 فاکتور ثبت شد - ID:", data.invoice_id);
                
                if (action === 'print_and_save') {
                    // باز کردن پنجره چاپ
                    const printUrl = "{% url 'invoice_app:invoice_print' 0 %}".replace('0', data.invoice_id);
                    window.open(printUrl, '_blank', 'width=800,height=600');
                    
                    setTimeout(function() {
                        const successUrl = "{% url 'invoice_app:invoice_success' 0 %}".replace('0', data.invoice_id);
                        window.location.href = successUrl;
                    }, 2000);
                } else {
                    const successUrl = "{% url 'invoice_app:invoice_success' 0 %}".replace('0', data.invoice_id);
                    window.location.href = successUrl;
                }
                
            } else {
                console.error("❌ خطا از سرور:", data.message);
                showToast('خطا در ثبت فاکتور: ' + data.message, 'error');
                $('.btn-success, .btn-secondary').prop('disabled', false);
                
                if (data.stock_errors) {
                    let errorMessage = "موجودی برخی کالاها کافی نیست:\n";
                    data.stock_errors.forEach(error => {
                        errorMessage += "• " + error + "\n";
                    });
                    alert(errorMessage);
                }
            }
        },
        error: function(xhr, status, error) {
            console.error("💥 خطای AJAX:", {
                status: status,
                error: error,
                responseText: xhr.responseText
            });
            
            let errorMessage = 'خطا در ارتباط با سرور';
            if (xhr.responseJSON && xhr.responseJSON.message) {
                errorMessage += ': ' + xhr.responseJSON.message;
            } else {
                errorMessage += ' (کد وضعیت: ' + xhr.status + ')';
            }
            
            showToast(errorMessage, 'error');
            $('.btn-success, .btn-secondary').prop('disabled', false);
        }
    });
};
window.cancelInvoice = function() {
    console.log("🔴 cancelInvoice فراخوانی شد");
    if (confirm('آیا از انصراف اطمینان دارید؟ تمام تغییرات از بین خواهد رفت.')) {
        window.location.href = "{% url 'invoice_app:invoice_cancel' %}";
    }
};
// تست ساده - اضافه کردن log به همه کلیک‌های دکمه
$(document).on('click', 'button', function(e) {
    const buttonText = $(this).text().trim();
    console.log("🟡 کلیک روی دکمه:", buttonText);
    
    // جلوگیری از ارسال فرم اگر دکمه داخل فرم باشد
    if ($(this).attr('type') !== 'submit') {
        e.preventDefault();
    }
});

// تست: آیا توابع در scope جهانی وجود دارند؟
console.log("✅ finalizeInvoice exists:", typeof window.finalizeInvoice);
console.log("✅ cancelInvoice exists:", typeof window.cancelInvoice);
// بررسی وجود دکمه‌ها بعد از بارگذاری صفحه
setTimeout(function() {
    const buttons = $('button');
    console.log("تعداد دکمه‌های صفحه:", buttons.length);
    
    buttons.each(function(index) {
        console.log(`دکمه ${index + 1}:`, $(this).text().trim());
    });
}, 1000);


// تابع getCookie (اگر وجود ندارد)
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
// متغیرهای global
// تابع ذخیره دستگاه POS انتخاب شده
function saveSelectedPosDevice() {
    const deviceId = $('#pos-device').val();
    
    if (!deviceId) {
        showToast('لطفا یک دستگاه پوز انتخاب کنید', 'error');
        return false;
    }
    
    $.ajax({
        url: "{% url 'invoice_app:save_pos_device' %}",
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({device_id: deviceId}),
        headers: {'X-CSRFToken': getCookie('csrftoken')},
        success: function(data) {
            if (data.status === 'success') {
                console.log('✅ دستگاه پوز انتخاب شده ذخیره شد');
            } else {
                console.error('❌ خطا در ذخیره دستگاه پوز:', data.message);
            }
        },
        error: function() {
            showToast('خطا در ذخیره دستگاه پوز', 'error');
            return false;
        }
    });
    
    return true;
}

// تابع بررسی اعتبارسنجی قبل از ثبت فاکتور
function validateInvoiceBeforeSubmit() {
    // بررسی آیتم‌ها
    const items = $('#invoice-items-list tr');
    const hasRealItems = items.length > 0 && 
                        !(items.length === 1 && items.find('td').hasClass('text-muted'));
    
    if (!hasRealItems) {
        showToast('فاکتور باید حداقل یک آیتم داشته باشد', 'error');
        return false;
    }
    
    // بررسی روش پرداخت - اگر انتخاب نشده، پیش‌فرض را تنظیم کن
    if (!currentPaymentMethod) {
        console.log("🟡 روش پرداخت انتخاب نشده، در حال تنظیم پیش‌فرض (POS)...");
        currentPaymentMethod = 'pos';
        
        // فعال کردن دکمه POS در interface
        $('.payment-method-btn').removeClass('active');
        $(`[data-method="pos"]`).addClass('active');
        
        // نمایش بخش دستگاه‌های POS
        $('#pos-devices-section').show();
        
        // ذخیره در session
        savePaymentMethod('pos');
        
        // اگر دستگاه پوز پیش‌فرض وجود دارد، آن را انتخاب کن
        const defaultPos = $('#pos-device option').first().val();
        if (defaultPos) {
            $('#pos-device').val(defaultPos);
            saveSelectedPosDevice();
        }
        
        showToast('روش پرداخت پیش‌فرض (دستگاه پوز) تنظیم شد', 'info');
    }
    
    // بررسی دستگاه POS اگر روش پرداخت POS است
    if (currentPaymentMethod === 'pos') {
        if (!$('#pos-device').val()) {
            showToast('لطفا یک دستگاه پوز انتخاب کنید', 'error');
            return false;
        }
    }
    
    return true;
}

// تابع ذخیره روش پرداخت
function savePaymentMethod(method) {
    console.log("💾 در حال ذخیره روش پرداخت:", method);
    
    $.ajax({
        url: "{% url 'invoice_app:save_payment_method' %}",
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({payment_method: method}),
        headers: {'X-CSRFToken': getCookie('csrftoken')},
        success: function(data) {
            if (data.status === 'success') {
                console.log("✅ روش پرداخت در session ذخیره شد");
            } else {
                console.error("❌ خطا در ذخیره روش پرداخت:", data.message);
            }
        },
        error: function(xhr, status, error) {
            console.error("💥 خطای AJAX در ذخیره روش پرداخت:", error);
        }
    });
}

// تابع اصلی برای افزودن دستگاه پوز
function addPosDevice() {
    const formData = {
        'name': $('#device-name').val().trim(),
        'account_holder': $('#account-holder').val().trim(),
        'card_number': $('#card-number').val().trim(),
        'account_number': $('#account-number').val().trim(),
        'bank_name': $('#bank-name').val().trim(),
        'action': 'add'
    };

    // اعتبارسنجی سمت کلاینت
    if (!formData.name) {
        showToast('لطفا نام دستگاه را وارد کنید', 'error');
        $('#device-name').focus();
        return;
    }
    if (!formData.account_holder) {
        showToast('لطفا نام صاحب حساب را وارد کنید', 'error');
        $('#account-holder').focus();
        return;
    }
    if (!formData.card_number) {
        showToast('لطفا شماره کارت را وارد کنید', 'error');
        $('#card-number').focus();
        return;
    }
    if (formData.card_number.length !== 16 || !/^\d+$/.test(formData.card_number)) {
        showToast('شماره کارت باید 16 رقم باشد', 'error');
        $('#card-number').focus();
        return;
    }
    if (!formData.account_number) {
        showToast('لطفا شماره حساب را وارد کنید', 'error');
        $('#account-number').focus();
        return;
    }
    if (!formData.bank_name) {
        showToast('لطفا نام بانک را وارد کنید', 'error');
        $('#bank-name').focus();
        return;
    }

    $('#addDeviceButton').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> در حال ثبت...');

    $.ajax({
        url: "{% url 'invoice_app:manage_pos_devices' %}",
        method: 'POST',
        data: formData,
        headers: {'X-CSRFToken': getCookie('csrftoken')},
        success: function(data) {
            if (data.status === 'success') {
                showToast('دستگاه با موفقیت اضافه شد', 'success');
                $('#device-name').val('');
                $('#account-holder').val('');
                $('#card-number').val('');
                $('#account-number').val('');
                $('#bank-name').val('');
                
                setTimeout(function() {
                    $('#posDeviceModal').modal('hide');
                    location.reload();
                }, 1500);
            } else {
                let errorMessage = 'خطا در ثبت دستگاه';
                if (data.errors) {
                    const errorList = Object.values(data.errors).flat();
                    errorMessage += '\n' + errorList.join('\n');
                } else if (data.message) {
                    errorMessage += ': ' + data.message;
                }
                showToast(errorMessage, 'error');
            }
        },
        error: function() {
            showToast('خطا در ارتباط با سرور', 'error');
        },
        complete: function() {
            $('#addDeviceButton').prop('disabled', false).html('<i class="fas fa-plus-circle"></i> افزودن دستگاه جدید');
        }
    });
}

// تابع نهایی کردن فاکتور - کاملاً بازنویسی شده
window.finalizeInvoice = function(action) {
    console.log("🔴 finalizeInvoice فراخوانی شد با action:", action);
    
    // 1. بررسی اعتبارسنجی
    if (!validateInvoiceBeforeSubmit()) {
        console.log("❌ اعتبارسنجی failed شد");
        return;
    }
    
    // 2. بررسی اطلاعات پرداخت خاص
    if (currentPaymentMethod === 'check') {
        if (!confirm('آیا اطلاعات چک را وارد کرده‌اید؟')) {
            $('#checkPaymentModal').modal('show');
            return;
        }
    }
    
    if (currentPaymentMethod === 'credit') {
        if (!confirm('آیا اطلاعات نسیه را وارد کرده‌اید؟')) {
            $('#creditPaymentModal').modal('show');
            return;
        }
    }
    
    // 3. تأیید نهایی کاربر
    const message = action === 'print_and_save' 
        ? 'آیا از ثبت و چاپ فاکتور اطمینان دارید؟'
        : 'آیا از ثبت فاکتور اطمینان دارید؟';
    
    if (!confirm(message)) {
        console.log("❌ کاربر انصراف داد");
        return;
    }
    
    console.log("🟡 تمام validationها passed شد");
    console.log("💰 روش پرداخت نهایی:", currentPaymentMethod);
    
    // 4. غیرفعال کردن دکمه‌ها
    $('.btn-success, .btn-secondary').prop('disabled', true);
    showToast('در حال ثبت فاکتور... لطفا منتظر بمانید', 'info');
    
    // 5. ارسال درخواست AJAX
    $.ajax({
        url: "{% url 'invoice_app:finalize_invoice' %}",
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            action: action,
            payment_method: currentPaymentMethod,
            timestamp: new Date().getTime()
        }),
        headers: {'X-CSRFToken': getCookie('csrftoken')},
        success: function(data) {
            console.log("✅ پاسخ سرور دریافت شد:", data);
            
            if (data.status === 'success') {
                showToast('فاکتور با موفقیت ثبت شد', 'success');
                console.log("🎉 فاکتور ثبت شد - ID:", data.invoice_id);
                
                if (action === 'print_and_save') {
                    const printUrl = "{% url 'invoice_app:invoice_print' 0 %}".replace('0', data.invoice_id);
                    window.open(printUrl, '_blank', 'width=800,height=600');
                    
                    setTimeout(function() {
                        const successUrl = "{% url 'invoice_app:invoice_success' 0 %}".replace('0', data.invoice_id);
                        window.location.href = successUrl;
                    }, 2000);
                } else {
                    const successUrl = "{% url 'invoice_app:invoice_success' 0 %}".replace('0', data.invoice_id);
                    window.location.href = successUrl;
                }
                
            } else {
                console.error("❌ خطا از سرور:", data.message);
                showToast('خطا در ثبت فاکتور: ' + data.message, 'error');
                $('.btn-success, .btn-secondary').prop('disabled', false);
                
                if (data.stock_errors) {
                    let errorMessage = "موجودی برخی کالاها کافی نیست:\n";
                    data.stock_errors.forEach(error => {
                        errorMessage += "• " + error + "\n";
                    });
                    alert(errorMessage);
                }
            }
        },
        error: function(xhr, status, error) {
            console.error("💥 خطای AJAX:", {status: status, error: error, responseText: xhr.responseText});
            
            let errorMessage = 'خطا در ارتباط با سرور';
            if (xhr.responseJSON && xhr.responseJSON.message) {
                errorMessage += ': ' + xhr.responseJSON.message;
            } else {
                errorMessage += ' (کد وضعیت: ' + xhr.status + ')';
            }
            
            showToast(errorMessage, 'error');
            $('.btn-success, .btn-secondary').prop('disabled', false);
        }
    });
};

// تابع لغو فاکتور
window.cancelInvoice = function() {
    if (confirm('آیا از انصراف اطمینان دارید؟ تمام تغییرات از بین خواهد رفت.')) {
        window.location.href = "{% url 'invoice_app:invoice_cancel' %}";
    }
};

// تنظیم event listenerهای روش پرداخت
function setupPaymentMethodListeners() {
    $('.payment-method-btn').off('click').on('click', function() {
        const method = $(this).data('method');
        console.log("🎯 روش پرداخت انتخاب شد:", method);
        
        currentPaymentMethod = method;
        $('.payment-method-btn').removeClass('active');
        $(this).addClass('active');
        
        $('#pos-devices-section').toggle(method === 'pos');
        
        if (method === 'check') {
            $('#checkPaymentModal').modal('show');
        } else if (method === 'credit') {
            $('#creditPaymentModal').modal('show');
        }
        
        savePaymentMethod(method);
        
        if (method === 'pos') {
            setTimeout(saveSelectedPosDevice, 100);
        }
    });
}

// وقتی صفحه کاملاً بارگذاری شد
$(document).ready(function() {
    console.log("🚀 صفحه کاملاً بارگذاری شد");
    
    // تنظیم روش پرداخت پیش‌فرض اگر انتخاب نشده
    if (!currentPaymentMethod || currentPaymentMethod === 'None') {
        currentPaymentMethod = 'pos';
        console.log("🟡 روش پرداخت پیش‌فرض تنظیم شد: POS");
        
        // فعال کردن دکمه POS
        $('[data-method="pos"]').addClass('active');
        
        // نمایش بخش دستگاه‌های POS
        $('#pos-devices-section').show();
        
        // ذخیره در session
        savePaymentMethod('pos');
    }
    
    // تنظیم listenerهای روش پرداخت
    setupPaymentMethodListeners();
    
    // نمایش وضعیت فعلی
    console.log("💰 روش پرداخت فعلی:", currentPaymentMethod);
    console.log("🔘 دکمه فعال:", $('.payment-method-btn.active').data('method'));
    
    // بقیه تنظیمات...
    setupBarcodeScanner();
    initializeDatePickers();
    setupEventListeners();
    
    setTimeout(function() {
        $('#product-search').focus();
    }, 500);
    
    calculateInvoiceTotal();
});


    </script>
</body>
</html>


