
{% load static %}
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³ÛŒØ³ØªÙ… ØµØ¯ÙˆØ± ÙØ§Ú©ØªÙˆØ± ÙØ±ÙˆØ´</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css">
    <style>
        :root {
            --primary-color: #2E7D32;
            --secondary-color: #388E3C;
            --accent-color: #1B5E20;
            --success-color: #4CAF50;
            --warning-color: #FF9800;
            --danger-color: #F44336;
            --text-color: #2c3e50;
            --light-bg: #f9f9f9;
            --border-color: #ddd;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --input-bg: #f1f8e9;
            --gradient-primary: linear-gradient(135deg, #2E7D32, #4CAF50);
            --gradient-success: linear-gradient(135deg, #4CAF50, #66BB6A);
            --gradient-warning: linear-gradient(135deg, #FF9800, #FFB74D);
            --gradient-danger: linear-gradient(135deg, #F44336, #EF5350);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Vazirmatn', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa, #e8f5e9);
            min-height: 100vh;
            padding: 10px;
            color: var(--text-color);
            direction: rtl;
            font-size: 14px;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .header h1 {
            font-size: 1.5rem;
            color: var(--accent-color);
            font-weight: 700;
        }

        .branch-info {
            background: var(--gradient-primary);
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(46, 125, 50, 0.3);
        }

        .section-card {
            background: white;
            border-radius: 10px;
            padding: 18px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid var(--border-color);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .section-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }

        .section-title {
            font-size: 1.1rem;
            color: var(--accent-color);
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e8f5e9;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .search-container {
            position: relative;
            margin-bottom: 15px;
        }

        .search-input {
            width: 100%;
            padding: 12px 45px 12px 12px;
            font-size: 1rem;
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            transition: all 0.3s;
            background: var(--input-bg);
        }

        .search-input:focus {
            box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
            border-color: var(--accent-color);
        }

        .search-results {
            border: 1px solid var(--border-color);
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 5px;
            background: white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: none;
            z-index: 1000;
            position: absolute;
            width: 100%;
        }

        .search-result-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.2s;
        }

        .search-result-item:hover {
            background-color: var(--light-bg);
        }

        .low-stock {
            background-color: #ffebee !important;
            color: #d32f2f !important;
        }

        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 0.9rem;
            border-radius: 8px;
            overflow: hidden;
        }

        .invoice-table th {
            background: var(--gradient-primary);
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: 600;
        }

        .invoice-table td {
            padding: 12px;
            border: 1px solid var(--border-color);
            text-align: center;
            transition: background 0.2s;
        }

        .invoice-table tr:hover td {
            background-color: #f8f9fa;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--gradient-success);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(46, 125, 50, 0.3);
        }

        .btn-success {
            background: var(--gradient-success);
            color: white;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #66BB6A, #81C784);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .btn-warning {
            background: var(--gradient-warning);
            color: white;
        }

        .btn-warning:hover {
            background: linear-gradient(135deg, #FFB74D, #FFCC80);
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--gradient-danger);
            color: white;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #EF5350, #E57373);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #78909c;
            color: white;
        }

        .btn-secondary:hover {
            background: #546e7a;
            transform: translateY(-2px);
        }

        .btn-outline-primary {
            background: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
        }

        .btn-outline-primary:hover {
            background: var(--primary-color);
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.8rem;
            border-radius: 20px;
        }

        .summary-card {
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            border: 2px solid var(--success-color);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.2);
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px dashed #bdbdbd;
            font-size: 0.95rem;
        }

        .summary-total {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--accent-color);
            margin-top: 10px;
        }

        .modal-content {
            border-radius: 12px;
            border: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .modal-header {
            background: var(--gradient-primary);
            color: white;
            border-bottom: none;
            padding: 15px 20px;
        }

        .modal-title {
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.9rem;
            color: var(--text-color);
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.9rem;
            transition: all 0.3s;
            background: white;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
            outline: none;
        }

        .form-control-sm {
            padding: 6px 10px;
            font-size: 0.85rem;
        }

        .payment-method-btn {
            width: 100%;
            padding: 15px;
            margin: 5px 0;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            text-align: right;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
        }

        .payment-method-btn:hover {
            border-color: var(--primary-color);
            background: #f1f8e9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .payment-method-btn.active {
            border-color: var(--accent-color);
            background: #e8f5e9;
            box-shadow: 0 2px 6px rgba(46, 125, 50, 0.2);
        }

        .discount-input {
            max-width: 200px;
        }

        .date-picker-container {
            position: relative;
        }

        .date-picker-container .form-control {
            padding-left: 40px;
        }

        .date-picker-icon {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary-color);
            cursor: pointer;
            font-size: 1.1rem;
        }

        .device-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .device-card:hover {
            border-color: var(--primary-color);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .device-card .card-body {
            padding: 12px;
        }

        .badge {
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 12px;
        }

        .bg-success {
            background: var(--success-color) !important;
        }

        .toast-container {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            z-index: 9999;
        }

        .toast {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-left: 4px solid var(--primary-color);
            margin-bottom: 10px;
            animation: slideIn 0.3s ease-out;
        }

        .toast.success {
            border-left-color: var(--success-color);
        }

        .toast.error {
            border-left-color: var(--danger-color);
        }

        .toast.warning {
            border-left-color: var(--warning-color);
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-card {
            animation: fadeIn 0.5s ease-out;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .action-buttons .btn {
            flex: 1;
            min-width: 120px;
        }

        .form-text {
            font-size: 0.8rem;
            color: #78909c;
            margin-top: 4px;
        }

        .text-muted {
            color: #78909c !important;
        }

        .border {
            border: 1px solid var(--border-color) !important;
        }

        .rounded {
            border-radius: 8px !important;
        }

        .table-responsive {
            border-radius: 8px;
            overflow: hidden;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .btn {
                padding: 8px 15px;
                font-size: 0.85rem;
            }
            
            .invoice-table {
                font-size: 0.8rem;
            }
            
            .invoice-table th,
            .invoice-table td {
                padding: 8px 5px;
            }
            
            .section-card {
                padding: 12px;
            }
            
            .payment-method-btn {
                padding: 12px;
                font-size: 0.85rem;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .action-buttons .btn {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-receipt"></i> Ø³ÛŒØ³ØªÙ… ØµØ¯ÙˆØ± ÙØ§Ú©ØªÙˆØ± ÙØ±ÙˆØ´</h1>
        </div>

        {% if not branch_selected %}
        <!-- ÙØ±Ù… Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¹Ø¨Ù‡ -->
        <div class="section-card">
            <h2 class="section-title"><i class="fas fa-store"></i> Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¹Ø¨Ù‡</h2>
            <form method="post">
                {% csrf_token %}
                <div class="form-group">
                    <label for="id_branch">Ø´Ø¹Ø¨Ù‡:</label>
                    {{ form.branch }}
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-check"></i> ØªØ§ÛŒÛŒØ¯ Ø´Ø¹Ø¨Ù‡
                </button>
            </form>
        </div>
        {% else %}
        <!-- ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ ÙØ§Ú©ØªÙˆØ± -->
        <div class="branch-info">
            <i class="fas fa-store"></i> Ø´Ø¹Ø¨Ù‡: {{ branch.name }} | 
            <i class="fas fa-user"></i> Ú©Ø§Ø±Ø¨Ø±: {{ user.get_full_name|default:user.username }}
        </div>

        <!-- Ø¯Ú©Ù…Ù‡ Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾ÙˆØ² -->
        <div class="section-card">
            <h3 class="section-title"><i class="fas fa-pos-terminal"></i> Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª</h3>
            <div class="row">
                <div class="col-md-6">
                    <button type="button" class="btn btn-primary w-100 mb-2" data-bs-toggle="modal" data-bs-target="#posDeviceModal">
                        <i class="fas fa-plus-circle"></i> Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø³ØªÚ¯Ø§Ù‡ Ù¾ÙˆØ² Ø¬Ø¯ÛŒØ¯
                    </button>
                </div>
                <div class="col-md-6">
                    <button type="button" class="btn btn-outline-primary w-100 mb-2" onclick="showAllPOSDevices()">
                        <i class="fas fa-list"></i> Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯
                    </button>
                </div>
            </div>
            
            <!-- Ù†Ù…Ø§ÛŒØ´ Ø¯Ø³ØªÚ¯Ø§Ù‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ -->
            {% if default_pos %}
            <div class="alert alert-info mt-2">
                <strong><i class="fas fa-star"></i> Ø¯Ø³ØªÚ¯Ø§Ù‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶:</strong>
                {{ default_pos.name }} - {{ default_pos.bank_name }}
            </div>
            {% endif %}
        </div>

        <!-- ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø®Ø±ÛŒØ¯Ø§Ø± Ùˆ ØªØ§Ø±ÛŒØ® -->
        <div class="section-card">
            <h3 class="section-title"><i class="fas fa-user"></i> Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ§Ú©ØªÙˆØ±</h3>
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="customer-name">Ù†Ø§Ù… Ø®Ø±ÛŒØ¯Ø§Ø±:</label>
                        <input type="text" id="customer-name" class="form-control" value="{{ customer_name }}" placeholder="Ù†Ø§Ù… Ø®Ø±ÛŒØ¯Ø§Ø±">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="customer-phone">ØªÙ„ÙÙ† Ø®Ø±ÛŒØ¯Ø§Ø±:</label>
                        <input type="text" id="customer-phone" class="form-control" value="{{ customer_phone }}" placeholder="ØªÙ„ÙÙ† Ø®Ø±ÛŒØ¯Ø§Ø±">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="invoice-date">ØªØ§Ø±ÛŒØ® ÙØ§Ú©ØªÙˆØ±:</label>
                        <div class="date-picker-container">
                            <i class="fas fa-calendar-alt date-picker-icon" onclick="openDatePicker()"></i>
                            <input type="text" id="invoice-date" class="form-control" readonly>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ø¨Ø®Ø´ Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª -->
        <div class="section-card">
            <h3 class="section-title"><i class="fas fa-credit-card"></i> Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª</h3>
            <div class="row">
                <div class="col-md-3">
                    <button type="button" class="payment-method-btn {% if payment_method == 'pos' %}active{% endif %}" data-method="pos">
                        <i class="fas fa-pos-terminal"></i>
                        <span>
                            Ø¯Ø³ØªÚ¯Ø§Ù‡ Ù¾ÙˆØ²
                            {% if default_pos %}
                            <br><small>{{ default_pos.name }}</small>
                            {% endif %}
                        </span>
                    </button>
                </div>
                <div class="col-md-3">
                    <button type="button" class="payment-method-btn {% if payment_method == 'cash' %}active{% endif %}" data-method="cash">
                        <i class="fas fa-money-bill-wave"></i>
                        <span>Ù†Ù‚Ø¯ÛŒ</span>
                    </button>
                </div>
                <div class="col-md-3">
                    <button type="button" class="payment-method-btn {% if payment_method == 'check' %}active{% endif %}" data-method="check">
                        <i class="fas fa-money-check"></i>
                        <span>Ú†Ú©</span>
                    </button>
                </div>
                <div class="col-md-3">
                    <button type="button" class="payment-method-btn {% if payment_method == 'credit' %}active{% endif %}" data-method="credit">
                        <i class="fas fa-calendar-day"></i>
                        <span>Ù†Ø³ÛŒÙ‡</span>
                    </button>
                </div>
            </div>

            <!-- Ø¨Ø®Ø´ Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾ÙˆØ² -->
            <div id="pos-devices-section" class="mt-3" style="display: {% if payment_method == 'pos' %}block{% else %}none{% endif %};">
                <div class="form-group">
                    <label for="pos-device">Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø³ØªÚ¯Ø§Ù‡ Ù¾ÙˆØ²:</label>
                    <select id="pos-device" class="form-control">
                        {% for device in pos_devices %}
                            <option value="{{ device.id }}" {% if default_pos and device.id == default_pos.id %}selected{% endif %}>
                                {{ device.name }} - {{ device.bank_name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <!-- Ø¨Ø®Ø´ Ø¬Ø³ØªØ¬Ùˆ Ùˆ Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ù„Ø§ -->
        <div class="section-card">
            <h3 class="section-title"><i class="fas fa-search"></i> Ø¬Ø³ØªØ¬Ùˆ Ùˆ Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ù„Ø§</h3>
            <div class="search-container">
                <input type="text" id="product-search" class="search-input" placeholder="Ù†Ø§Ù… ÛŒØ§ Ø¨Ø§Ø±Ú©Ø¯ Ú©Ø§Ù„Ø§ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯...">
                <div id="search-results" class="search-results"></div>
            </div>
            <small class="text-muted">Ø¨Ø±Ø§ÛŒ Ø¬Ø³ØªØ¬ÙˆØŒ Ø­Ø¯Ø§Ù‚Ù„ 2 Ú©Ø§Ø±Ø§Ú©ØªØ± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</small>
        </div>

        <!-- Ù„ÛŒØ³Øª Ú©Ø§Ù„Ø§Ù‡Ø§ÛŒ ÙØ§Ú©ØªÙˆØ± -->
        <div class="section-card">
            <h3 class="section-title"><i class="fas fa-list"></i> Ù„ÛŒØ³Øª Ú©Ø§Ù„Ø§Ù‡Ø§ÛŒ ÙØ§Ú©ØªÙˆØ±</h3>
            <div class="table-responsive">
                <table class="invoice-table">
                    <thead>
                        <tr>
                            <th>Ù†Ø§Ù… Ú©Ø§Ù„Ø§</th>
                            <th>ØªØ¹Ø¯Ø§Ø¯</th>
                            <th>Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯</th>
                            <th>ØªØ®ÙÛŒÙ Ø¢ÛŒØªÙ…</th>
                            <th>Ù‚ÛŒÙ…Øª Ú©Ù„</th>
                            <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="invoice-items-list">
                        {% for item in items %}
                        <tr id="item-{{ item.product_id }}">
                            <td>{{ item.product_name }}</td>
                            <td>
                                <input type="number" class="form-control form-control-sm quantity-input" 
                                       value="{{ item.quantity }}" min="1" 
                                       data-product-id="{{ item.product_id }}" 
                                       style="width: 80px; display: inline-block;">
                            </td>
                            <td>{{ item.price|floatformat:"0" }} ØªÙˆÙ…Ø§Ù†</td>
                            <td>
                                <input type="number" class="form-control form-control-sm discount-input" 
                                       value="{{ item.discount|default:0 }}" min="0" 
                                       data-product-id="{{ item.product_id }}"
                                       style="width: 100px; display: inline-block;">
                            </td>
                            <td>{{ item.total|floatformat:"0" }} ØªÙˆÙ…Ø§Ù†</td>
                            <td>
                                <button class="btn btn-danger btn-sm" onclick="removeItem({{ item.product_id }})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Ø®Ù„Ø§ØµÙ‡ ÙØ§Ú©ØªÙˆØ± Ùˆ ØªØ®ÙÛŒÙ -->
        <div class="section-card summary-card">
            <h3 class="section-title"><i class="fas fa-calculator"></i> Ø®Ù„Ø§ØµÙ‡ ÙØ§Ú©ØªÙˆØ±</h3>
            <div class="row">
                <div class="col-md-6">
                    <div class="summary-item">
                        <span>ØªØ¹Ø¯Ø§Ø¯ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§:</span>
                        <span id="total-items">{{ items|length }}</span>
                    </div>
                    <div class="summary-item">
                        <span>Ø¬Ù…Ø¹ Ú©Ù„ Ø¨Ø¯ÙˆÙ† ØªØ®ÙÛŒÙ:</span>
                        <span id="total-without-discount">0 ØªÙˆÙ…Ø§Ù†</span>
                    </div>
                    <div class="summary-item">
                        <span>ØªØ®ÙÛŒÙ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§:</span>
                        <span id="items-discount">0 ØªÙˆÙ…Ø§Ù†</span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="total-discount">ØªØ®ÙÛŒÙ Ú©Ù„ ÙØ§Ú©ØªÙˆØ± (ØªÙˆÙ…Ø§Ù†):</label>
                        <input type="number" id="total-discount" class="form-control discount-input" 
                               value="{{ discount }}" min="0" style="max-width: 200px;">
                    </div>
                    <div class="summary-item summary-total">
                        <span>Ù…Ø¨Ù„Øº Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª:</span>
                        <span id="total-amount">{{ total_amount|floatformat:"0" }} ØªÙˆÙ…Ø§Ù†</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ù‚Ø¯Ø§Ù… -->
        <div class="section-card">
            <div class="action-buttons">
                <button type="button" class="btn btn-danger" onclick="cancelInvoice()">
                    <i class="fas fa-times"></i> Ø§Ù†ØµØ±Ø§Ù Ùˆ Ù„ØºÙˆ ÙØ§Ú©ØªÙˆØ±
                </button>
                <div class="d-flex" style="gap: 10px;">
                    <button type="button" class="btn btn-secondary" onclick="finalizeInvoice('save_only')">
                        <i class="fas fa-save"></i> Ø«Ø¨Øª ÙØ§Ú©ØªÙˆØ±
                    </button>
                    <button type="button" class="btn btn-success" onclick="finalizeInvoice('print_and_save')">
                        <i class="fas fa-print"></i> Ø«Ø¨Øª Ùˆ Ú†Ø§Ù¾ ÙØ§Ú©ØªÙˆØ±
                    </button>
                </div>
            </div>
        </div>

        <!-- Ø³ÛŒØ³ØªÙ… Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ -->
        <div id="toast-container" class="toast-container"></div>
        {% endif %}
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø¯Ø³ØªÚ¯Ø§Ù‡ Ù¾ÙˆØ² -->
    <div class="modal fade" id="posDeviceModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-pos-terminal"></i> Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾ÙˆØ²</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- ÙØ±Ù… Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø¬Ø¯ÛŒØ¯ -->
                    <div class="mb-4">
                        <h6><i class="fas fa-plus-circle"></i> Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø¬Ø¯ÛŒØ¯:</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="device-name" class="form-label">Ù†Ø§Ù… Ø¯Ø³ØªÚ¯Ø§Ù‡ *</label>
                                    <input type="text" class="form-control" id="device-name" placeholder="Ù…Ø«Ø§Ù„: Ù¾ÙˆØ² Ø¨Ø§Ù†Ú© Ù…Ù„Øª" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="account-holder" class="form-label">Ù†Ø§Ù… ØµØ§Ø­Ø¨ Ø­Ø³Ø§Ø¨ *</label>
                                    <input type="text" class="form-control" id="account-holder" placeholder="Ù†Ø§Ù… Ú©Ø§Ù…Ù„ ØµØ§Ø­Ø¨ Ø­Ø³Ø§Ø¨" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="card-number" class="form-label">Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª *</label>
                                    <input type="text" class="form-control" id="card-number" maxlength="16" placeholder="16 Ø±Ù‚Ù… Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª" required>
                                    <small class="form-text text-muted">Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª Ø¨Ø§ÛŒØ¯ 16 Ø±Ù‚Ù… Ø¨Ø§Ø´Ø¯</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="account-number" class="form-label">Ø´Ù…Ø§Ø±Ù‡ Ø­Ø³Ø§Ø¨ *</label>
                                    <input type="text" class="form-control" id="account-number" placeholder="Ø´Ù…Ø§Ø±Ù‡ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù†Ú©ÛŒ" required>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="bank-name" class="form-label">Ù†Ø§Ù… Ø¨Ø§Ù†Ú© *</label>
                            <input type="text" class="form-control" id="bank-name" placeholder="Ù…Ø«Ø§Ù„: Ø¨Ø§Ù†Ú© Ù…Ù„Øª" required>
                        </div>
                    </div>

                    <hr>

                    <!-- Ù„ÛŒØ³Øª Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ -->
                    <h6><i class="fas fa-list"></i> Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯:</h6>
                    <div id="pos-devices-list" class="mb-3">
                        {% for device in pos_devices %}
                        <div class="card device-card">
                            <div class="card-body py-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>{{ device.name }}</strong> - {{ device.bank_name }}
                                        {% if device.is_default %}
                                            <span class="badge bg-success me-2"><i class="fas fa-star"></i> Ù¾ÛŒØ´ ÙØ±Ø¶</span>
                                        {% endif %}
                                        <br>
                                        <small class="text-muted">
                                            <i class="fas fa-credit-card"></i> Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª: {{ device.card_number }} | 
                                            <i class="fas fa-user"></i> ØµØ§Ø­Ø¨ Ø­Ø³Ø§Ø¨: {{ device.account_holder }}
                                        </small>
                                    </div>
                                    <div>
                                        {% if not device.is_default %}
                                        <button class="btn btn-sm btn-outline-success me-1 set-default-btn" 
                                                data-device-id="{{ device.id }}" title="ØªÙ†Ø¸ÛŒÙ… Ù¾ÛŒØ´â€ŒÙØ±Ø¶">
                                            <i class="fas fa-star"></i>
                                        </button>
                                        {% endif %}
                                        <button class="btn btn-sm btn-outline-danger delete-device-btn" 
                                                data-device-id="{{ device.id }}" title="Ø­Ø°Ù Ø¯Ø³ØªÚ¯Ø§Ù‡">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center text-muted p-3 border rounded">
                            <i class="fas fa-info-circle fa-2x mb-2"></i>
                            <p>Ù‡ÛŒÚ† Ø¯Ø³ØªÚ¯Ø§Ù‡ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Ø¨Ø³ØªÙ†
                    </button>
                    <button type="button" class="btn btn-success" id="addDeviceButton">
                        <i class="fas fa-plus-circle"></i> Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø¬Ø¯ÛŒØ¯
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª Ú†Ú© -->
    <div class="modal fade" id="checkPaymentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-money-check"></i> Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø±Ø¯Ø§Ø®Øª Ú†Ú©</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="check-payment-form">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Ù†Ø§Ù… ØµØ§Ø­Ø¨ Ú†Ú©:</label>
                                    <input type="text" name="owner_name" class="form-control" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ ØµØ§Ø­Ø¨ Ú†Ú©:</label>
                                    <input type="text" name="owner_family" class="form-control" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Ú©Ø¯ Ù…Ù„ÛŒ:</label>
                                    <input type="text" name="national_id" class="form-control" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>ØªÙ„ÙÙ†:</label>
                                    <input type="text" name="phone" class="form-control" required>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Ø¢Ø¯Ø±Ø³:</label>
                            <textarea name="address" class="form-control" rows="3"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Ø´Ù…Ø§Ø±Ù‡ Ú†Ú©:</label>
                                    <input type="text" name="check_number" class="form-control" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Ù…Ø¨Ù„Øº Ú†Ú© (ØªÙˆÙ…Ø§Ù†):</label>
                                    <input type="number" name="amount" class="form-control" required>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>ØªØ§Ø±ÛŒØ® Ú†Ú©:</label>
                            <div class="date-picker-container">
                                <i class="fas fa-calendar-alt date-picker-icon" onclick="openCheckDatePicker()"></i>
                                <input type="text" name="check_date" class="form-control" id="check-date" readonly required>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¨Ø³ØªÙ†</button>
                    <button type="button" class="btn btn-primary" onclick="saveCheckPayment()">Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú†Ú©</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ø³ÛŒÙ‡ -->
    <div class="modal fade" id="creditPaymentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-calendar-day"></i> Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ø³ÛŒÙ‡</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="credit-payment-form">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Ù†Ø§Ù…:</label>
                                    <input type="text" name="customer_name" class="form-control" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ:</label>
                                    <input type="text" name="customer_family" class="form-control" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>ØªÙ„ÙÙ†:</label>
                                    <input type="text" name="phone" class="form-control" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Ú©Ø¯ Ù…Ù„ÛŒ:</label>
                                    <input type="text" name="national_id" class="form-control" required>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Ø¢Ø¯Ø±Ø³:</label>
                            <textarea name="address" class="form-control" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label>ØªØ§Ø±ÛŒØ® Ø³Ø±Ø±Ø³ÛŒØ¯:</label>
                            <div class="date-picker-container">
                                <i class="fas fa-calendar-alt date-picker-icon" onclick="openDueDatePicker()"></i>
                                <input type="text" name="due_date" class="form-control" id="due-date" readonly required>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¨Ø³ØªÙ†</button>
                    <button type="button" class="btn btn-primary" onclick="saveCreditPayment()">Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù†Ø³ÛŒÙ‡</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ø§Ø³Ú©Ø±ÛŒÙ¾Øªâ€ŒÙ‡Ø§ -->
    <script src="{% static 'js/jQueryv3.7.1.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/persian-date@1.1.0/dist/persian-date.min.js"></script>
    <script src="https://unpkg.com/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>
    
    <script>
        // Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ global
        let currentPaymentMethod = '{{ payment_method }}';
        let searchTimeout = null;
        let invoiceDatePicker, checkDatePicker, dueDatePicker;

        // ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø³ØªÚ¯Ø§Ù‡ Ù¾ÙˆØ²
        function addPosDevice() {
            console.log("âœ… ØªØ§Ø¨Ø¹ addPosDevice Ø§Ø¬Ø±Ø§ Ø´Ø¯!");
            
            // Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ±Ù…
            const formData = {
                'name': $('#device-name').val().trim(),
                'account_holder': $('#account-holder').val().trim(),
                'card_number': $('#card-number').val().trim(),
                'account_number': $('#account-number').val().trim(),
                'bank_name': $('#bank-name').val().trim(),
                'action': 'add'
            };

            console.log("ğŸ“‹ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ±Ù…:", formData);

            // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø³Ù…Øª Ú©Ù„Ø§ÛŒÙ†Øª
            if (!formData.name) {
                showToast('Ù„Ø·ÙØ§ Ù†Ø§Ù… Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error');
                $('#device-name').focus();
                return;
            }
            if (!formData.account_holder) {
                showToast('Ù„Ø·ÙØ§ Ù†Ø§Ù… ØµØ§Ø­Ø¨ Ø­Ø³Ø§Ø¨ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error');
                $('#account-holder').focus();
                return;
            }
            if (!formData.card_number) {
                showToast('Ù„Ø·ÙØ§ Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error');
                $('#card-number').focus();
                return;
            }
            if (formData.card_number.length !== 16 || !/^\d+$/.test(formData.card_number)) {
                showToast('Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª Ø¨Ø§ÛŒØ¯ 16 Ø±Ù‚Ù… Ø¨Ø§Ø´Ø¯', 'error');
                $('#card-number').focus();
                return;
            }
            if (!formData.account_number) {
                showToast('Ù„Ø·ÙØ§ Ø´Ù…Ø§Ø±Ù‡ Ø­Ø³Ø§Ø¨ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error');
                $('#account-number').focus();
                return;
            }
            if (!formData.bank_name) {
                showToast('Ù„Ø·ÙØ§ Ù†Ø§Ù… Ø¨Ø§Ù†Ú© Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error');
                $('#bank-name').focus();
                return;
            }

            // Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ
            $('#addDeviceButton').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øª...');

            // Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª AJAX
            $.ajax({
                url: "{% url 'invoice_app:manage_pos_devices' %}",
                method: 'POST',
                data: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                success: function(data) {
                    console.log("âœ… Ù¾Ø§Ø³Ø® Ø³Ø±ÙˆØ±:", data);
                    
                    if (data.status === 'success') {
                        showToast('Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯', 'success');
                        
                        // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙØ±Ù…
                        $('#device-name').val('');
                        $('#account-holder').val('');
                        $('#card-number').val('');
                        $('#account-number').val('');
                        $('#bank-name').val('');
                        
                        // Ø¨Ø³ØªÙ† Ù…ÙˆØ¯Ø§Ù„ Ùˆ Ø±ÙØ±Ø´ ØµÙØ­Ù‡
                        setTimeout(function() {
                            $('#posDeviceModal').modal('hide');
                            location.reload();
                        }, 1500);
                        
                    } else {
                        let errorMessage = 'Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø¯Ø³ØªÚ¯Ø§Ù‡';
                        if (data.errors) {
                            const errorList = Object.values(data.errors).flat();
                            errorMessage += '\n' + errorList.join('\n');
                        } else if (data.message) {
                            errorMessage += ': ' + data.message;
                        }
                        showToast(errorMessage, 'error');
                    }
                },
                error: function(xhr, status, error) {
                    console.error("âŒ Ø®Ø·Ø§ÛŒ AJAX:", error);
                    showToast('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±. Ù„Ø·ÙØ§ Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.', 'error');
                },
                complete: function() {
                    $('#addDeviceButton').prop('disabled', false).html('<i class="fas fa-plus-circle"></i> Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø¬Ø¯ÛŒØ¯');
                }
            });
        }

        // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù‡Ù…Ù‡ Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§
        function showAllPOSDevices() {
            if ($('#pos-devices-list .card').length > 0) {
                $('#posDeviceModal').modal('show');
            } else {
                showToast('Ù‡ÛŒÚ† Ø¯Ø³ØªÚ¯Ø§Ù‡ Ù¾ÙˆØ²ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª. Ù„Ø·ÙØ§ Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯.', 'warning');
            }
        }
        
        // ÙˆÙ‚ØªÛŒ ØµÙØ­Ù‡ Ú©Ø§Ù…Ù„Ø§Ù‹ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯
        $(document).ready(function() {
            console.log("âœ… ØµÙØ­Ù‡ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯");
            
            // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§
            initializeDatePickers();
            
            // Ø±ÙˆÛŒØ¯Ø§Ø¯ Ú©Ù„ÛŒÚ© Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡ Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø³ØªÚ¯Ø§Ù‡
            $('#addDeviceButton').on('click', function(e) {
                e.preventDefault();
                console.log("ğŸ–±ï¸ Ø¯Ú©Ù…Ù‡ Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø³ØªÚ¯Ø§Ù‡ Ú©Ù„ÛŒÚ© Ø´Ø¯");
                addPosDevice();
            });

            // Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø­Ø°Ù Ø¯Ø³ØªÚ¯Ø§Ù‡
            $(document).on('click', '.delete-device-btn', function() {
                const deviceId = $(this).data('device-id');
                const deviceName = $(this).closest('.card').find('strong').text();
                
                if (confirm(`Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø¯Ø³ØªÚ¯Ø§Ù‡ "${deviceName}" Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ`)) {
                    deletePosDevice(deviceId);
                }
            });

            // Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ ØªÙ†Ø¸ÛŒÙ… Ù¾ÛŒØ´â€ŒÙØ±Ø¶
            $(document).on('click', '.set-default-btn', function() {
                const deviceId = $(this).data('device-id');
                const deviceName = $(this).closest('.card').find('strong').text();
                
                if (confirm(`Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø¯Ø³ØªÚ¯Ø§Ù‡ "${deviceName}" Ø±Ø§ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù¾ÛŒØ´â€ŒÙØ±Ø¶ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯ØŸ`)) {
                    setDefaultPosDevice(deviceId);
                }
            });

            // ÙˆÙ‚ØªÛŒ Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø§Ø² Ù…ÛŒâ€ŒØ´ÙˆØ¯
            $('#posDeviceModal').on('shown.bs.modal', function () {
                $('#device-name').focus();
            });

            // ØªÙ†Ø¸ÛŒÙ… event listeners Ø¯ÛŒÚ¯Ø±
            setupEventListeners();
        });

        // ØªØ§Ø¨Ø¹ Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ ØªÙ‚ÙˆÛŒÙ…â€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø³ÛŒ
        function initializeDatePickers() {
            // ØªØ§Ø±ÛŒØ® ÙØ§Ú©ØªÙˆØ±
            invoiceDatePicker = $('#invoice-date').persianDatepicker({
                format: 'YYYY/MM/DD',
                initialValue: true,
                initialValueType: 'persian',
                autoClose: true,
                observer: true,
                position: 'auto'
            });

            // ØªØ§Ø±ÛŒØ® Ú†Ú©
            checkDatePicker = $('#check-date').persianDatepicker({
                format: 'YYYY/MM/DD',
                initialValue: true,
                initialValueType: 'persian',
                autoClose: true,
                observer: true,
                position: 'auto'
            });

            // ØªØ§Ø±ÛŒØ® Ø³Ø±Ø±Ø³ÛŒØ¯ Ù†Ø³ÛŒÙ‡
            dueDatePicker = $('#due-date').persianDatepicker({
                format: 'YYYY/MM/DD',
                initialValue: false,
                initialValueType: 'persian',
                autoClose: true,
                observer: true,
                position: 'auto'
            });

            console.log("âœ… ØªÙ‚ÙˆÛŒÙ…â€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø³ÛŒ Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø´Ø¯Ù†Ø¯");
        }

        // ØªÙˆØ§Ø¨Ø¹ Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† ØªÙ‚ÙˆÛŒÙ…
        function openDatePicker() {
            invoiceDatePicker.persianDatepicker('show');
        }

        function openCheckDatePicker() {
            checkDatePicker.persianDatepicker('show');
        }

        function openDueDatePicker() {
            dueDatePicker.persianDatepicker('show');
        }

        // ØªØ§Ø¨Ø¹ Ø­Ø°Ù Ø¯Ø³ØªÚ¯Ø§Ù‡
        function deletePosDevice(deviceId) {
            $.ajax({
                url: "{% url 'invoice_app:manage_pos_devices' %}",
                method: 'POST',
                data: {
                    'action': 'delete',
                    'device_id': deviceId
                },
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                success: function(data) {
                    if (data.status === 'success') {
                        showToast('Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯', 'success');
                        location.reload();
                    } else {
                        showToast('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø¯Ø³ØªÚ¯Ø§Ù‡: ' + (data.message || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡'), 'error');
                    }
                },
                error: function(xhr, status, error) {
                    showToast('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±', 'error');
                }
            });
        }

        // ØªØ§Ø¨Ø¹ ØªÙ†Ø¸ÛŒÙ… Ø¯Ø³ØªÚ¯Ø§Ù‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶
        function setDefaultPosDevice(deviceId) {
            $.ajax({
                url: "{% url 'invoice_app:manage_pos_devices' %}",
                method: 'POST',
                data: {
                    'action': 'set_default',
                    'device_id': deviceId
                },
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                success: function(data) {
                    if (data.status === 'success') {
                        showToast('Ø¯Ø³ØªÚ¯Ø§Ù‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªØºÛŒÛŒØ± Ú©Ø±Ø¯', 'success');
                        location.reload();
                    } else {
                        showToast('Ø®Ø·Ø§ Ø¯Ø± ØªØºÛŒÛŒØ± Ø¯Ø³ØªÚ¯Ø§Ù‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶: ' + (data.message || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡'), 'error');
                    }
                },
                error: function(xhr, status, error) {
                    showToast('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±', 'error');
                }
            });
        }

        // ØªÙ†Ø¸ÛŒÙ… event listeners
        function setupEventListeners() {
            // Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…Ø­ØµÙˆÙ„
            $('#product-search').on('input', function() {
                clearTimeout(searchTimeout);
                const query = $(this).val().trim();
                
                if (query.length < 2) {
                    $('#search-results').hide().empty();
                    return;
                }
                
                searchTimeout = setTimeout(() => searchProduct(query), 300);
            });

            // ØªØºÛŒÛŒØ± ØªØ¹Ø¯Ø§Ø¯ Ù…Ø­ØµÙˆÙ„
            $(document).on('change', '.quantity-input', function() {
                const productId = $(this).data('product-id');
                const newQuantity = parseInt($(this).val());
                updateItemQuantity(productId, newQuantity);
            });

            // ØªØºÛŒÛŒØ± ØªØ®ÙÛŒÙ Ø¢ÛŒØªÙ…
            $(document).on('change', '.discount-input', function() {
                const productId = $(this).data('product-id');
                const discount = parseInt($(this).val());
                updateItemDiscount(productId, discount);
            });

            // ØªØºÛŒÛŒØ± ØªØ®ÙÛŒÙ Ú©Ù„
            $('#total-discount').on('change', function() {
                const discount = parseInt($(this).val());
                saveDiscount(discount);
            });

            // Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø®Ø±ÛŒØ¯Ø§Ø±
            $('#customer-name, #customer-phone').on('blur', saveCustomerInfo);

            // Ø§Ù†ØªØ®Ø§Ø¨ Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª
            $('.payment-method-btn').click(function() {
                const method = $(this).data('method');
                currentPaymentMethod = method;
                
                // Ø¨Ù‡ Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
                $('.payment-method-btn').removeClass('active');
                $(this).addClass('active');
                
                // Ù†Ù…Ø§ÛŒØ´/Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ø¨Ø®Ø´ Ù…Ø±Ø¨ÙˆØ·Ù‡
                $('#pos-devices-section').toggle(method === 'pos');
                
                // Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø±Ø§ÛŒ Ú†Ú© Ùˆ Ù†Ø³ÛŒÙ‡
                if (method === 'check') {
                    $('#checkPaymentModal').modal('show');
                } else if (method === 'credit') {
                    $('#creditPaymentModal').modal('show');
                }
                
                savePaymentMethod(method);
            });

            // Ø±ÙˆÛŒØ¯Ø§Ø¯ Ú©Ù„ÛŒÚ© Ø¨Ø±Ø§ÛŒ Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ
            $(document).on('click', '.search-result-item', function() {
                const productId = $(this).data('product-id');
                addToInvoice(productId);
                $('#product-search').val('');
                $('#search-results').hide();
            });
        }

        // ØªÙˆØ§Ø¨Ø¹ Ù¾Ø±Ø¯Ø§Ø®Øª Ú†Ú©
        function saveCheckPayment() {
            const formData = {
                'owner_name': $('input[name="owner_name"]').val(),
                'owner_family': $('input[name="owner_family"]').val(),
                'national_id': $('input[name="national_id"]').val(),
                'phone': $('input[name="phone"]').val(),
                'address': $('textarea[name="address"]').val(),
                'check_number': $('input[name="check_number"]').val(),
                'amount': $('input[name="amount"]').val(),
                'check_date': $('input[name="check_date"]').val()
            };

            // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ
            if (!formData.owner_name || !formData.owner_family || !formData.national_id || 
                !formData.phone || !formData.check_number || !formData.amount || !formData.check_date) {
                showToast('Ù„Ø·ÙØ§ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯', 'error');
                return;
            }

            $.ajax({
                url: "{% url 'invoice_app:save_check_payment' %}",
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                headers: {'X-CSRFToken': getCookie('csrftoken')},
                success: function(data) {
                    if (data.status === 'success') {
                        showToast('Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú†Ú© Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯', 'success');
                        $('#checkPaymentModal').modal('hide');
                    } else {
                        showToast('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú†Ú©', 'error');
                    }
                },
                error: function() {
                    showToast('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±', 'error');
                }
            });
        }

        // ØªÙˆØ§Ø¨Ø¹ Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ø³ÛŒÙ‡
        function saveCreditPayment() {
            const formData = {
                'customer_name': $('input[name="customer_name"]').val(),
                'customer_family': $('input[name="customer_family"]').val(),
                'phone': $('input[name="phone"]').val(),
                'national_id': $('input[name="national_id"]').val(),
                'address': $('textarea[name="address"]').val(),
                'due_date': $('input[name="due_date"]').val()
            };

            // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ
            if (!formData.customer_name || !formData.customer_family || !formData.phone || 
                !formData.national_id || !formData.due_date) {
                showToast('Ù„Ø·ÙØ§ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯', 'error');
                return;
            }

            $.ajax({
                url: "{% url 'invoice_app:save_credit_payment' %}",
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                headers: {'X-CSRFToken': getCookie('csrftoken')},
                success: function(data) {
                    if (data.status === 'success') {
                        showToast('Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù†Ø³ÛŒÙ‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯', 'success');
                        $('#creditPaymentModal').modal('hide');
                    } else {
                        showToast('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù†Ø³ÛŒÙ‡', 'error');
                    }
                },
                error: function() {
                    showToast('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±', 'error');
                }
            });
        }

        // Ø³Ø§ÛŒØ± ØªÙˆØ§Ø¨Ø¹
        function searchProduct(query) {
            $.ajax({
                url: "{% url 'invoice_app:invoice_search_product' %}",
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({query: query}),
                headers: {'X-CSRFToken': getCookie('csrftoken')},
                success: function(data) {
                    displaySearchResults(data.results);
                },
                error: function() {
                    showToast('Ø®Ø·Ø§ Ø¯Ø± Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…Ø­ØµÙˆÙ„', 'error');
                }
            });
        }
        
        function removeItem(productId) {
            if (!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ú©Ø§Ù„Ø§ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) return;
            
            $.ajax({
                url: "{% url 'invoice_app:invoice_remove_item' %}",
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({product_id: productId}),
                headers: {'X-CSRFToken': getCookie('csrftoken')},
                success: function(data) {
                    if (data.status === 'success') {
                        updateInvoiceTable(data.items);
                        updateInvoiceSummary();
                        showToast('Ú©Ø§Ù„Ø§ Ø­Ø°Ù Ø´Ø¯', 'success');
                    }
                },
                error: function() {
                    showToast('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ú©Ø§Ù„Ø§', 'error');
                }
            });
        }
        
        function updateInvoiceSummary() {
            // Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÛŒØ§Ø² Ø´Ù…Ø§
        }

        function saveCustomerInfo() {
            const name = $('#customer-name').val();
            const phone = $('#customer-phone').val();
            
            $.ajax({
                url: "{% url 'invoice_app:save_customer_info' %}",
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({customer_name: name, customer_phone: phone}),
                headers: {'X-CSRFToken': getCookie('csrftoken')},
                success: function(data) {
                    if (data.status === 'success') {
                        showToast('Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø´ØªØ±ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯', 'success');
                    }
                },
                error: function() {
                    showToast('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø´ØªØ±ÛŒ', 'error');
                }
            });
        }

        function savePaymentMethod(method) {
            $.ajax({
                url: "{% url 'invoice_app:save_payment_method' %}",
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({payment_method: method}),
                headers: {'X-CSRFToken': getCookie('csrftoken')},
                error: function() {
                    showToast('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª', 'error');
                }
            });
        }

        function saveDiscount(discount) {
            $.ajax({
                url: "{% url 'invoice_app:save_discount' %}",
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({discount: discount}),
                headers: {'X-CSRFToken': getCookie('csrftoken')},
                success: function(data) {
                    if (data.status === 'success') {
                        updateInvoiceSummary();
                    }
                },
                error: function() {
                    showToast('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ ØªØ®ÙÛŒÙ', 'error');
                }
            });
        }

        function updateItemQuantity(productId, quantity) {
            $.ajax({
                url: "{% url 'invoice_app:update_item_quantity' %}",
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({product_id: productId, quantity: quantity}),
                headers: {'X-CSRFToken': getCookie('csrftoken')},
                success: function(data) {
                    if (data.status === 'success') {
                        updateInvoiceTable(data.items);
                        updateInvoiceSummary();
                    }
                },
                error: function() {
                    showToast('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡ Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªØ¹Ø¯Ø§Ø¯', 'error');
                }
            });
        }

        function updateItemDiscount(productId, discount) {
            $.ajax({
                url: "{% url 'invoice_app:update_item_discount' %}",
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({product_id: productId, discount: discount}),
                headers: {'X-CSRFToken': getCookie('csrftoken')},
                success: function(data) {
                    if (data.status === 'success') {
                        updateInvoiceTable(data.items);
                        updateInvoiceSummary();
                    }
                },
                error: function() {
                    showToast('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡ Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªØ®ÙÛŒÙ', 'error');
                }
            });
        }

        function finalizeInvoice(action) {
            if ($('#invoice-items-list tr').length === 0) {
                showToast('ÙØ§Ú©ØªÙˆØ± Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ø¢ÛŒØªÙ… Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯', 'error');
                return;
            }
            
            const message = action === 'print_and_save' 
                ? 'Ø¢ÛŒØ§ Ø§Ø² Ø«Ø¨Øª Ùˆ Ú†Ø§Ù¾ ÙØ§Ú©ØªÙˆØ± Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ'
                : 'Ø¢ÛŒØ§ Ø§Ø² Ø«Ø¨Øª ÙØ§Ú©ØªÙˆØ± Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ';
            
            if (confirm(message)) {
                // Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø«Ø¨Øª ÙØ§Ú©ØªÙˆØ±
                showToast('ÙØ§Ú©ØªÙˆØ± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯', 'success');
            }
        }

        function cancelInvoice() {
            if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ø§Ù†ØµØ±Ø§Ù Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ ØªÙ…Ø§Ù… ØªØºÛŒÛŒØ±Ø§Øª Ø§Ø² Ø¨ÛŒÙ† Ø®ÙˆØ§Ù‡Ø¯ Ø±ÙØª.')) {
                window.location.href = "{% url 'invoice_app:invoice_cancel' %}";
            }
        }

        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ØªØ§Ø¨Ø¹ Ø¨Ù‡ Ù…Ø­ÛŒØ· global Ø¨Ø±Ø§ÛŒ ØªØ³Øª Ø¯Ø³ØªÛŒ
        window.addPosDevice = addPosDevice;
        
        
        
        
        
        
// Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø¬Ù‡Ø§Ù†ÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ø¨Ø§Ø±Ú©Ø¯
let barcodeBuffer = "";
let barcodeTimeout = null;
const BARCODE_DELAY = 150; // Ù…ÛŒÙ„ÛŒâ€ŒØ«Ø§Ù†ÛŒÙ‡ Ø¨ÛŒÙ† Ú©Ø§Ø±Ø§Ú©ØªØ±Ù‡Ø§ÛŒ Ø¨Ø§Ø±Ú©Ø¯
let lastBarcodeTime = 0;

// ÙˆÙ‚ØªÛŒ ØµÙØ­Ù‡ Ú©Ø§Ù…Ù„Ø§Ù‹ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯
$(document).ready(function() {
    console.log("âœ… Ø³ÛŒØ³ØªÙ… Ø§Ø³Ú©Ù† Ø¨Ø§Ø±Ú©Ø¯ ÙØ¹Ø§Ù„ Ø´Ø¯");
    
    // ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø³ÛŒØ³ØªÙ… Ø§Ø³Ú©Ù† Ø¨Ø§Ø±Ú©Ø¯
    setupBarcodeScanner();
    
    // Ø³Ø§ÛŒØ± ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÙˆÙ„ÛŒÙ‡
    initializeDatePickers();
    calculateInvoiceTotal();
    setupEventListeners();
});

// ØªÙ†Ø¸ÛŒÙ… Ø³ÛŒØ³ØªÙ… Ø§Ø³Ú©Ù† Ø¨Ø§Ø±Ú©Ø¯
function setupBarcodeScanner() {
    // Ø±ÙˆÛŒØ¯Ø§Ø¯ keydown Ø¨Ø±Ø§ÛŒ ØªØ´Ø®ÛŒØµ Enter Ø¨Ø§Ø±Ú©Ø¯Ø®ÙˆØ§Ù†
    $('#product-search').on('keydown', function(e) {
        const currentTime = new Date().getTime();
        
        // Ø§Ú¯Ø± Ú©Ù„ÛŒØ¯ Enter ÙØ´Ø±Ø¯Ù‡ Ø´Ø¯
        if (e.key === 'Enter' || e.keyCode === 13) {
            e.preventDefault();
            console.log("ğŸ” Enter ØªØ´Ø®ÛŒØµ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯ØŒ Ø¨Ø§Ø±Ú©Ø¯:", barcodeBuffer);
            
            // Ø§Ú¯Ø± Ø¨Ø§Ø±Ú©Ø¯ Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª
            if (barcodeBuffer.length >= 6) {
                processBarcodeScan(barcodeBuffer);
            }
            
            barcodeBuffer = "";
            $(this).val('');
            return;
        }
        
        // Ø§Ú¯Ø± Ú©Ø§Ø±Ø§Ú©ØªØ± Ù…Ø¹Ù…ÙˆÙ„ÛŒ Ø§Ø³Øª (Ø§Ø¹Ø¯Ø§Ø¯ØŒ Ø­Ø±ÙˆÙ)
        if (e.key.length === 1 && e.key !== ' ' && e.key !== 'Enter') {
            // ØªØ´Ø®ÛŒØµ Ø³Ø±Ø¹Øª ØªØ§ÛŒÙ¾ (Ø¨Ø§Ø±Ú©Ø¯Ø®ÙˆØ§Ù† Ø³Ø±ÛŒØ¹ØªØ± Ø§Ø³Øª)
            if (currentTime - lastBarcodeTime < BARCODE_DELAY) {
                barcodeBuffer += e.key;
            } else {
                // Ø§Ú¯Ø± ØªØ£Ø®ÛŒØ± Ø²ÛŒØ§Ø¯ Ø¨ÙˆØ¯ØŒ Ø§Ø­ØªÙ…Ø§Ù„Ø§Ù‹ ØªØ§ÛŒÙ¾ Ø¯Ø³ØªÛŒ Ø§Ø³Øª
                barcodeBuffer = e.key;
            }
            
            lastBarcodeTime = currentTime;
            
            // Ø±ÛŒØ³Øª ØªØ§ÛŒÙ…Ø± Ø¨Ø±Ø§ÛŒ ØªØ´Ø®ÛŒØµ Ù¾Ø§ÛŒØ§Ù† Ø¨Ø§Ø±Ú©Ø¯
            clearTimeout(barcodeTimeout);
            barcodeTimeout = setTimeout(function() {
                // Ø§Ú¯Ø± Ø¨Ø§Ø±Ú©Ø¯ Ø¹Ø¯Ø¯ÛŒ Ø·ÙˆÙ„Ø§Ù†ÛŒ Ø§Ø³ØªØŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ú©Ù†
                if (barcodeBuffer.length >= 8 && /^\d+$/.test(barcodeBuffer)) {
                    console.log("ğŸ” Ø¨Ø§Ø±Ú©Ø¯ Ø®ÙˆØ¯Ú©Ø§Ø± ØªØ´Ø®ÛŒØµ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯:", barcodeBuffer);
                    processBarcodeScan(barcodeBuffer);
                    barcodeBuffer = "";
                    $('#product-search').val('');
                }
            }, BARCODE_DELAY + 50);
        }
    });
    
    // Ø±ÙˆÛŒØ¯Ø§Ø¯ input Ø¨Ø±Ø§ÛŒ Ø­Ø§Ù„Øª Ø¯ÙˆÙ… ØªØ´Ø®ÛŒØµ
    $('#product-search').on('input', function(e) {
        const value = $(this).val().trim();
        
        // Ø§Ú¯Ø± Ù…Ù‚Ø¯Ø§Ø± Ø¨Ù‡ Ø§Ù†Ø¯Ø§Ø²Ù‡ Ú©Ø§ÙÛŒ Ø·ÙˆÙ„Ø§Ù†ÛŒ Ø§Ø³Øª Ùˆ ÙÙ‚Ø· Ø¹Ø¯Ø¯ Ø§Ø³Øª
        if (value.length >= 8 && /^\d+$/.test(value)) {
            clearTimeout(barcodeTimeout);
            
            barcodeTimeout = setTimeout(() => {
                console.log("ğŸ” Ø¨Ø§Ø±Ú©Ø¯ Ø§Ø² Ø·Ø±ÛŒÙ‚ input ØªØ´Ø®ÛŒØµ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯:", value);
                processBarcodeScan(value);
                $(this).val('');
            }, 300);
        }
    });
}

// Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø§Ø³Ú©Ù† Ø¨Ø§Ø±Ú©Ø¯
function processBarcodeScan(barcode) {
    console.log("ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¨Ø§Ø±Ú©Ø¯:", barcode);
    
    // Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬Ùˆ
    showToast('Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬ÙˆÛŒ Ú©Ø§Ù„Ø§...', 'info');
    
    $.ajax({
        url: "{% url 'invoice_app:invoice_search_product' %}",
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            query: barcode,
            is_barcode: true // Ù…Ø´Ø®Øµ Ú©Ø±Ø¯Ù† Ú©Ù‡ Ø§ÛŒÙ† Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø§Ø±Ú©Ø¯ Ø§Ø³Øª
        }),
        headers: {'X-CSRFToken': getCookie('csrftoken')},
        success: function(data) {
            console.log("âœ… Ù¾Ø§Ø³Ø® Ø¬Ø³ØªØ¬Ùˆ:", data);
            
            if (data.error) {
                showToast('Ø®Ø·Ø§ Ø¯Ø± Ø¬Ø³ØªØ¬Ùˆ: ' + data.error, 'error');
                return;
            }
            
            if (!data.results || data.results.length === 0) {
                showToast('Ú©Ø§Ù„Ø§ÛŒÛŒ Ø¨Ø§ Ø§ÛŒÙ† Ø¨Ø§Ø±Ú©Ø¯ ÛŒØ§ÙØª Ù†Ø´Ø¯', 'warning');
                $('#product-search').val('').focus();
                return;
            }
            
            // Ø§Ú¯Ø± Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ ÛŒÚ© Ù†ØªÛŒØ¬Ù‡ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯ØŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†
            if (data.results.length === 1) {
                const product = data.results[0];
                console.log("âœ… Ú©Ø§Ù„Ø§ÛŒ ÛŒØ§ÙØª Ø´Ø¯Ù‡:", product.name);
                
                // Ø¨Ø±Ø±Ø³ÛŒ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù†
                if (product.quantity <= 0) {
                    if (confirm(`Ú©Ø§Ù„Ø§ÛŒ "${product.name}" Ù…ÙˆØ¬ÙˆØ¯ÛŒ ØµÙØ± Ø¯Ø§Ø±Ø¯. Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§Ø¯Ø§Ù…Ù‡ Ø¯Ù‡ÛŒØ¯ØŸ`)) {
                        addToInvoice(product.id, 1, true); // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø§Ø¬Ø¨Ø§Ø±ÛŒ
                    } else {
                        $('#product-search').val('').focus();
                    }
                } else {
                    addToInvoice(product.id, 1, true); // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¹Ø§Ø¯ÛŒ
                }
                
            } else {
                // Ø§Ú¯Ø± Ú†Ù†Ø¯ÛŒÙ† Ù†ØªÛŒØ¬Ù‡ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯ØŒ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø¯Ù‡
                showToast('Ú†Ù†Ø¯ Ú©Ø§Ù„Ø§ ÛŒØ§ÙØª Ø´Ø¯. Ù„Ø·ÙØ§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯', 'info');
                displaySearchResults(data.results);
            }
        },
        error: function(xhr, status, error) {
            console.error("âŒ Ø®Ø·Ø§ÛŒ AJAX:", error);
            showToast('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±', 'error');
            $('#product-search').val('').focus();
        }
    });
}

// ØªØ§Ø¨Ø¹ Ø¨Ù‡Ø¨ÙˆØ¯ ÛŒØ§ÙØªÙ‡ Ø¨Ø±Ø§ÛŒ Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ ÙØ§Ú©ØªÙˆØ±
function addToInvoice(productId, quantity = 1, isAutoAdd = false) {
    console.log("ğŸ”„ Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ù„Ø§ Ø¨Ù‡ ÙØ§Ú©ØªÙˆØ±:", productId, "Auto:", isAutoAdd);
    
    $.ajax({
        url: "{% url 'invoice_app:invoice_add_item' %}",
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            product_id: productId,
            quantity: quantity,
            is_auto_add: isAutoAdd // Ù…Ø´Ø®Øµ Ú©Ø±Ø¯Ù† Ø­Ø§Ù„Øª Ø®ÙˆØ¯Ú©Ø§Ø±
        }),
        headers: {'X-CSRFToken': getCookie('csrftoken')},
        success: function(data) {
            console.log("âœ… Ù¾Ø§Ø³Ø® Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ù„Ø§:", data);
            
            if (data.status === 'success') {
                updateInvoiceTable(data.items);
                calculateInvoiceTotal();
                
                if (isAutoAdd) {
                    showToast('Ú©Ø§Ù„Ø§ Ø¨Ù‡ Ø·ÙˆØ± Ø®ÙˆØ¯Ú©Ø§Ø± Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯ âœ“', 'success');
                } else {
                    showToast('Ú©Ø§Ù„Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯', 'success');
                }
                
                // Ù‡Ù…ÛŒØ´Ù‡ ÙÛŒÙ„Ø¯ Ø¬Ø³ØªØ¬Ùˆ Ø±Ø§ Ù¾Ø§Ú© Ú©Ù† Ùˆ ÙÙˆÚ©ÙˆØ³ Ø±Ø§ Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†
                $('#product-search').val('').focus();
                $('#search-results').hide();
                
            } else if (data.status === 'error') {
                // Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§Ù‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ÛŒ
                if (data.message.includes('Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª')) {
                    if (confirm(data.message + '\n\nØ¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§Ø¯Ø§Ù…Ù‡ Ø¯Ù‡ÛŒØ¯ØŸ')) {
                        forceAddToInvoice(productId, quantity);
                    } else {
                        $('#product-search').val('').focus();
                    }
                } else {
                    showToast(data.message, 'error');
                    $('#product-search').val('').focus();
                }
            }
        },
        error: function(xhr, status, error) {
            console.error("âŒ Ø®Ø·Ø§ÛŒ Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ù„Ø§:", error);
            showToast('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±', 'error');
            $('#product-search').val('').focus();
        }
    });
}

// ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø§ÙØ²ÙˆØ¯Ù† Ø§Ø¬Ø¨Ø§Ø±ÛŒ
function forceAddToInvoice(productId, quantity = 1) {
    $.ajax({
        url: "{% url 'invoice_app:invoice_add_item' %}",
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            product_id: productId,
            quantity: quantity,
            ignore_stock: true // Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ú¯Ø±ÙØªÙ† Ù…ÙˆØ¬ÙˆØ¯ÛŒ
        }),
        headers: {'X-CSRFToken': getCookie('csrftoken')},
        success: function(data) {
            if (data.status === 'success') {
                updateInvoiceTable(data.items);
                calculateInvoiceTotal();
                showToast('Ú©Ø§Ù„Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯ (Ø¨Ø§ ÙˆØ¬ÙˆØ¯ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ù…ÙˆØ¬ÙˆØ¯ÛŒ)', 'warning');
                $('#product-search').val('').focus();
            }
        },
        error: function() {
            showToast('Ø®Ø·Ø§ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ù„Ø§', 'error');
        }
    });
}

// ØªØ§Ø¨Ø¹ Ø¨Ù‡ Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¬Ø¯ÙˆÙ„ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§
function updateInvoiceTable(items) {
    const tbody = $('#invoice-items-list');
    tbody.empty();
    
    if (items.length === 0) {
        tbody.append('<tr><td colspan="6" class="text-center text-muted py-3">Ù‡ÛŒÚ† Ú©Ø§Ù„Ø§ÛŒÛŒ Ø¯Ø± ÙØ§Ú©ØªÙˆØ± ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</td></tr>');
        return;
    }
    
    items.forEach(item => {
        const row = `
            <tr id="item-${item.product_id}">
                <td>${item.product_name}</td>
                <td>
                    <input type="number" class="form-control form-control-sm quantity-input" 
                           value="${item.quantity}" min="1" 
                           data-product-id="${item.product_id}" 
                           style="width: 80px; display: inline-block;">
                </td>
                <td>${item.price.toLocaleString('fa-IR')}</td>
                <td>
                    <input type="number" class="form-control form-control-sm discount-input" 
                           value="${item.discount || 0}" min="0" 
                           data-product-id="${item.product_id}"
                           style="width: 100px; display: inline-block;">
                </td>
                <td>${(item.total - (item.discount || 0)).toLocaleString('fa-IR')}</td>
                <td>
                    <button class="btn btn-danger btn-sm" onclick="removeItem(${item.product_id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
        tbody.append(row);
    });
}

// ØªØ§Ø¨Ø¹ Ù†Ù…Ø§ÛŒØ´ Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ (ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø­Ø§Ù„ØªÛŒ Ú©Ù‡ Ú†Ù†Ø¯ Ù†ØªÛŒØ¬Ù‡ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯)
function displaySearchResults(results) {
    const container = $('#search-results');
    container.empty();
    
    results.forEach((product) => {
        const stockStatus = product.quantity <= 0 ? 
            '<span class="badge bg-danger">Ù…ÙˆØ¬ÙˆØ¯ÛŒ ØµÙØ±</span>' : 
            `<span class="badge bg-success">Ù…ÙˆØ¬ÙˆØ¯ÛŒ: ${product.quantity}</span>`;
        
        const item = $(`
            <div class="search-result-item" data-product-id="${product.id}">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${product.name}</strong>
                        <div class="text-muted small">Ù‚ÛŒÙ…Øª: ${product.price.toLocaleString('fa-IR')}</div>
                    </div>
                    ${stockStatus}
                </div>
                ${product.barcode ? `<div class="small text-muted">Ø¨Ø§Ø±Ú©Ø¯: ${product.barcode}</div>` : ''}
            </div>
        `);
        
        item.click(function() {
            addToInvoice(product.id, 1);
            container.hide();
        });
        
        container.append(item);
    });
    
    container.show();
}

// Ø³Ø§ÛŒØ± ØªÙˆØ§Ø¨Ø¹ Ø¶Ø±ÙˆØ±ÛŒ
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showToast(message, type = 'info') {
    const toast = $(`
        <div class="toast ${type}">
            <div class="toast-body">
                <div class="d-flex justify-content-between align-items-center">
                    <span>${message}</span>
                    <button type="button" class="btn-close" onclick="$(this).closest('.toast').remove()"></button>
                </div>
            </div>
        </div>
    `);
    
    $('#toast-container').append(toast);
    
    setTimeout(() => {
        toast.fadeOut(300, function() {
            $(this).remove();
        });
    }, 3000);
}        
    </script>
</body>
</html>

