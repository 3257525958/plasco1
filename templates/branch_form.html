{% load static %}
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if edit_mode %}ویرایش{% else %}تعریف{% endif %} شعبه</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #388E3C;
            --accent-color: #2E7D32;
            --text-color: #2c3e50;
            --light-bg: #f9f9f9;
            --border-color: #ddd;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --input-bg: #f1f8e9;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa, #e8f5e9);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-color);
            font-family: 'Vazirmatn', sans-serif;
        }

        .form-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: var(--shadow);
            padding: 30px;
        }

        .form-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }

        .form-title {
            color: var(--primary-color);
            font-weight: bold;
            font-size: 28px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 18px;
            color: var(--secondary-color);
        }

        .form-control {
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 18px;
            transition: all 0.3s;
            background-color: var(--input-bg);
        }

        .form-control:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 4px rgba(46, 125, 50, 0.3);
        }

        .search-container {
            position: relative;
            margin-bottom: 15px;
        }

        #seller-search {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            border: 2px solid var(--primary-color);
            border-radius: 10px;
            transition: all 0.3s;
            background: var(--input-bg);
        }

        #seller-search:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 4px rgba(46, 125, 50, 0.3);
        }

        #seller-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid var(--primary-color);
            border-radius: 10px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
            max-height: 300px;
            overflow-y: auto;
        }

        .seller-result-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 18px;
        }

        .seller-result-item:hover {
            background-color: #f1f8e9;
        }

        .selected-sellers-container {
            margin-top: 20px;
            padding: 15px;
            border: 2px dashed var(--border-color);
            border-radius: 10px;
            background-color: #f9f9f9;
        }

        .selected-seller {
            display: inline-block;
            margin: 5px;
            padding: 10px 15px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 20px;
            font-size: 16px;
        }

        .remove-seller {
            margin-right: 8px;
            cursor: pointer;
        }

        .btn {
            padding: 14px 30px;
            border: none;
            border-radius: 50px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--primary-color), var(--accent-color));
            color: white;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 18px;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="form-container">
        <div class="form-header">
            <h1 class="form-title">{% if edit_mode %}ویرایش{% else %}تعریف{% endif %} شعبه جدید</h1>
        </div>

        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{% if message.tags == 'success' %}success{% else %}error{% endif %}">
                    <i class="fas fa-{% if message.tags == 'success' %}check-circle{% else %}exclamation-circle{% endif %}"></i>
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}

        <form method="post" id="branch-form">
            {% csrf_token %}
            
            <div class="form-group">
                <label class="form-label">نام شعبه</label>
                <input type="text" name="name" class="form-control" required 
                       value="{{ form.name.value|default:'' }}" placeholder="نام شعبه را وارد کنید">
                {% if form.name.errors %}
                    <div class="text-danger mt-2">
                        {% for error in form.name.errors %}
                            <span>{{ error }}</span>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>

            <div class="form-group">
                <label class="form-label">آدرس شعبه</label>
                <textarea name="address" class="form-control" rows="3" required 
                          placeholder="آدرس شعبه را وارد کنید">{{ form.address.value|default:'' }}</textarea>
                {% if form.address.errors %}
                    <div class="text-danger mt-2">
                        {% for error in form.address.errors %}
                            <span>{{ error }}</span>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>

            <div class="form-group">
                <label class="form-label">افزودن فروشنده</label>
                <div class="search-container">
                    <input type="text" id="seller-search" placeholder="جستجوی فروشنده با نام، نام خانوادگی یا کد ملی (حداقل ۲ کاراکتر)" autocomplete="off">
                    <div id="seller-results"></div>
                </div>
                
                <input type="hidden" name="sellers" id="selected-sellers" value="{{ form.sellers.value|join:',' }}">
                
                <div class="selected-sellers-container">
                    <div id="selected-sellers-list">
                        {% for seller in form.sellers.value %}
                            <div class="selected-seller" data-id="{{ seller.id }}">
                                <span class="remove-seller" data-id="{{ seller.id }}">
                                    <i class="fas fa-times-circle"></i>
                                </span>
                                {{ seller.firstname }} {{ seller.lastname }} ({{ seller.melicode }})
                            </div>
                        {% endfor %}
                    </div>
                </div>
                {% if form.sellers.errors %}
                    <div class="text-danger mt-2">
                        {% for error in form.sellers.errors %}
                            <span>{{ error }}</span>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>

            <div class="form-actions" style="text-align: left;">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> {% if edit_mode %}ویرایش{% else %}ذخیره{% endif %} شعبه
                </button>
                <a href="{% url 'cantact_app:branch_list' %}" class="btn btn-secondary">
                    <i class="fas fa-list"></i> مشاهده لیست شعب
                </a>
            </div>
        </form>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>

// تابع تبدیل اعداد فارسی و عربی به انگلیسی
function convertPersianToEnglishNumbers(input) {
    if (!input) return input;
    
    const persianNumbers = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹'];
    const arabicNumbers = ['٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩'];
    
    let output = input;
    for (let i = 0; i < 10; i++) {
        let persianRegex = new RegExp(persianNumbers[i], 'g');
        let arabicRegex = new RegExp(arabicNumbers[i], 'g');
        output = output.replace(persianRegex, i).replace(arabicRegex, i);
    }
    
    return output;
}

$(document).ready(function() {
    let selectedSellers = [];
    
    // مقداردهی اولیه فروشندگان انتخاب شده در حالت ویرایش
    {% if form.sellers.value %}
        {% for seller in form.sellers.value %}
            selectedSellers.push({
                id: "{{ seller.id }}",
                name: "{{ seller.firstname }} {{ seller.lastname }}",
                melicode: "{{ seller.melicode }}"
            });
        {% endfor %}
    {% endif %}
    
    // جستجوی فروشنده
    $('#seller-search').on('input', function() {
        let query = $(this).val().trim();
        query = convertPersianToEnglishNumbers(query);
        const $results = $('#seller-results');
        
        if (query.length < 2) {
            $results.empty().hide();
            return;
        }
        
        $.ajax({
            url: "{% url 'cantact_app:search_sellers' %}",
            data: { q: query },
            dataType: 'json',
            success: function(data) {
                $results.empty();
                
                if (data.results.length > 0) {
                    data.results.forEach(seller => {
                        // بررسی تکراری نبودن فروشنده
                        const isSelected = selectedSellers.some(s => s.id == seller.id);
                        if (!isSelected) {
                            $results.append(`
                                <div class="seller-result-item" 
                                     data-id="${seller.id}"
                                     data-name="${seller.firstname} ${seller.lastname}"
                                     data-melicode="${seller.melicode}">
                                    <i class="fas fa-user"></i> 
                                    ${seller.firstname} ${seller.lastname} - کد ملی: ${seller.melicode}
                                </div>
                            `);
                        }
                    });
                } else {
                    $results.append(`
                        <div class="seller-result-item">
                            <i class="fas fa-exclamation-circle"></i> 
                            فروشنده ای یافت نشد
                        </div>
                    `);
                }
                
                $results.show();
            },
            error: function() {
                $results.append(`
                    <div class="seller-result-item">
                        <i class="fas fa-exclamation-triangle"></i> 
                        خطا در ارتباط با سرور
                    </div>
                `);
                $results.show();
            }
        });
    });
    
    // انتخاب فروشنده از نتایج جستجو
    $('#seller-results').on('click', '.seller-result-item', function() {
        const sellerId = $(this).data('id');
        const sellerName = $(this).data('name');
        const melicode = $(this).data('melicode');
        
        // بررسی تکراری نبودن فروشنده
        if (!selectedSellers.some(seller => seller.id == sellerId)) {
            selectedSellers.push({
                id: sellerId,
                name: sellerName,
                melicode: melicode
            });
            
            updateSelectedSellersList();
        }
        
        $('#seller-search').val('');
        $('#seller-results').empty().hide();
    });
    
    // به روزرسانی لیست فروشندگان انتخاب شده
    function updateSelectedSellersList() {
        const $container = $('#selected-sellers-list');
        $container.empty();
        
        selectedSellers.forEach(seller => {
            $container.append(`
                <div class="selected-seller" data-id="${seller.id}">
                    <span class="remove-seller" data-id="${seller.id}">
                        <i class="fas fa-times-circle"></i>
                    </span>
                    ${seller.name} (${seller.melicode})
                </div>
            `);
        });
        
        // به روزرسانی فیلد مخفی - اطمینان از فرمت صحیح
        $('#selected-sellers').val(selectedSellers.map(s => s.id).join(','));
    }
    
    // حذف فروشنده از لیست انتخاب شده
    $('#selected-sellers-list').on('click', '.remove-seller', function() {
        const sellerId = $(this).data('id');
        selectedSellers = selectedSellers.filter(seller => seller.id != sellerId);
        updateSelectedSellersList();
    });
    
    // مخفی کردن نتایج جستجو هنگام کلیک خارج
    $(document).on('click', function(e) {
        if (!$('#seller-results').is(e.target) && 
            $('#seller-results').has(e.target).length === 0 &&
            !$('#seller-search').is(e.target)) {
            $('#seller-results').hide();
        }
    });
    
    // مقداردهی اولیه لیست فروشندگان انتخاب شده
    updateSelectedSellersList();
    
    // اعتبارسنجی فرم
    $('#branch-form').submit(function(e) {
        let isValid = true;
        
        // بررسی نام شعبه
        const name = $('input[name="name"]').val().trim();
        if (!name) {
            $('input[name="name"]').addClass('is-invalid');
            isValid = false;
        } else {
            $('input[name="name"]').removeClass('is-invalid');
        }
        
        // بررسی آدرس شعبه
        const address = $('textarea[name="address"]').val().trim();
        if (!address) {
            $('textarea[name="address"]').addClass('is-invalid');
            isValid = false;
        } else {
            $('textarea[name="address"]').removeClass('is-invalid');
        }
        
        if (!isValid) {
            e.preventDefault();
            $('#message-container').html(`
                <div class="alert alert-error">
                    <i class="fas fa-exclamation-circle"></i>
                    لطفاً فیلدهای ضروری را پر کنید.
                </div>
            `);
            
            // اسکرول به بالای فرم برای نمایش خطاها
            $('html, body').animate({
                scrollTop: $('.form-container').offset().top
            }, 500);
        }
    });
});
    </script>
</body>
</html>