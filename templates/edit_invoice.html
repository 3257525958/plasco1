{% load static %}
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ویرایش فاکتور - فروشگاه پلاستیک و لوازم آشپرخانه موسوی</title>
    
    <!-- فونت‌ها و آیکون‌ها -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #388E3C;
            --accent-color: #2E7D32;
            --text-color: #2c3e50;
            --light-bg: #f9f9f9;
            --border-color: #ddd;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --input-bg: #f1f8e9;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Vazirmatn', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa, #e8f5e9);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-color);
            direction: rtl;
        }

        .edit-invoice-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: var(--shadow);
            padding: 30px;
        }

        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
            flex-wrap: wrap;
            gap: 20px;
        }

        .search-section {
            margin-bottom: 20px;
        }

        .search-container {
            position: relative;
        }

        .search-label {
            display: block;
            margin-bottom: 8px;
            font-size: 16px;
            color: #555;
            font-weight: bold;
        }

        .search-input {
            width: 100%;
            padding: 12px 45px 12px 12px;
            font-size: 16px;
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            transition: all 0.3s;
            background: var(--input-bg);
        }

        .search-input:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 8px rgba(46, 125, 50, 0.3);
            outline: none;
        }

        .search-btn {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--primary-color);
            font-size: 18px;
            cursor: pointer;
        }

        .search-hint {
            margin-top: 5px;
            font-size: 14px;
            color: #666;
        }

        .search-results {
            border: 1px solid var(--border-color);
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 8px;
            background: white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: none;
            z-index: 1000;
            position: absolute;
            width: 100%;
        }

        .search-result-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.2s;
        }

        .search-result-item:hover {
            background-color: var(--light-bg);
        }

        .invoice-details {
            display: none;
            margin-top: 20px;
        }

        .invoice-info {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .info-item {
            margin-bottom: 10px;
            padding: 8px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }

        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            margin: 25px 0;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
        }

        .invoice-table th {
            background-color: var(--primary-color);
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 18px;
        }

        .invoice-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
        }

        .invoice-table input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            text-align: center;
            font-size: 18px;
            transition: all 0.3s;
        }

        .price-input {
            font-size: 20px !important;
            font-weight: bold;
            padding: 14px 15px !important;
            background-color: #f8fff8;
        }

        .line-total-input {
            font-size: 20px !important;
            font-weight: bold;
            padding: 14px 15px !important;
            background-color: #e8f5e9;
            border: 1px solid #4CAF50;
            cursor: not-allowed;
        }

        .price-words {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            text-align: center;
            direction: rtl;
            height: 20px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .invoice-summary {
            margin-top: 30px;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 10px;
            border: 1px solid #ddd;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .summary-item.total-payable {
            font-weight: bold;
            font-size: 20px;
            color: #2E7D32;
            border-top: 2px solid #ddd;
            padding-top: 10px;
            margin-top: 10px;
        }

        .actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 14px 30px;
            border: none;
            border-radius: 50px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--primary-color), var(--accent-color));
            color: white;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-back {
            background: #9e9e9e;
            color: white;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
        }

        .error-message {
            color: #d32f2f;
            background-color: #ffebee;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #d32f2f;
            font-size: 18px;
        }

        .success-message {
            color: #2E7D32;
            background-color: #e8f5e9;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #2E7D32;
            font-size: 18px;
        }

        @media (max-width: 768px) {
            .edit-invoice-container {
                padding: 15px;
                border-radius: 15px;
            }
            
            .invoice-table {
                display: block;
                width: 100%;
                overflow-x: auto;
            }
            
            .btn {
                padding: 12px 20px;
                font-size: 16px;
                width: 100%;
                justify-content: center;
                margin-bottom: 10px;
            }
            
            .actions {
                flex-direction: column-reverse;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="edit-invoice-container">
        <div class="header-section">
            <h1>ویرایش فاکتور</h1>
        </div>

        <div class="search-section">
            <div class="search-container">
                <label class="search-label">جستجوی فاکتور برای ویرایش:</label>
                <input type="text" id="edit-invoice-search" class="search-input" placeholder="شماره فاکتور، نام فروشنده یا نام خانوادگی...">
                <button type="button" class="search-btn">
                    <i class="fas fa-search"></i>
                </button>
                <div id="edit-invoice-search-results" class="search-results"></div>
            </div>
            <div class="search-hint">برای جستجو، حداقل 2 کاراکتر وارد کنید</div>
        </div>

        <div id="invoice-details" class="invoice-details">
            <h3>مشخصات فاکتور</h3>
            <div id="invoice-info" class="invoice-info">
                <!-- اطلاعات فاکتور اینجا نمایش داده می‌شود -->
            </div>

            <h3>لیست کالاهای فاکتور</h3>
            <table class="invoice-table">
                <thead>
                    <tr>
                        <th width="30%">نام کالا</th>
                        <th width="15%">قیمت خرید (تومان)</th>
                        <th width="10%">تعداد</th>
                        <th width="15%">جمع کل (تومان)</th>
                        <th width="15%">تخفیف (تومان)</th>
                        <th width="15%">عملیات</th>
                    </tr>
                </thead>
                <tbody id="invoice-items-list">
                    <!-- آیتم‌های فاکتور اینجا نمایش داده می‌شوند -->
                </tbody>
            </table>

            <button id="add-item-btn" class="btn btn-secondary">
                <i class="fas fa-plus"></i> اضافه کردن کالا
            </button>

            <div class="invoice-summary">
                <div class="summary-item">
                    <span>تعداد اقلام:</span>
                    <span id="total-items">0</span>
                </div>
                <div class="summary-item">
                    <span>جمع کل فاکتور:</span>
                    <span id="total-amount">0 تومان</span>
                </div>
                <div class="summary-item">
                    <span>تخفیف کل:</span>
                    <span id="total-discount">0 تومان</span>
                </div>
                <div class="summary-item total-payable">
                    <span>قابل پرداخت:</span>
                    <span id="final-amount">0 تومان</span>
                </div>
            </div>

            <div class="actions">
                <button id="edit-invoice-back-btn" class="btn btn-back">
                    <i class="fas fa-arrow-right"></i> بازگشت
                </button>
                <button id="edit-invoice-submit-btn" class="btn btn-primary">
                    <i class="fas fa-save"></i> ذخیره تغییرات
                </button>
            </div>
        </div>

        <div id="messages"></div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // متغیرهای global برای مدیریت ویرایش فاکتور
        let editingInvoice = null;
        let editingInvoiceItems = [];
        let invoiceSearchTimeout = null;

        // تابع تبدیل اعداد فارسی و عربی به انگلیسی
        function convertPersianToEnglishNumbers(input) {
            if (!input) return input;
            
            const persianNumbers = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹'];
            const arabicNumbers = ['٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩'];
            
            let output = input;
            for (let i = 0; i < 10; i++) {
                let persianRegex = new RegExp(persianNumbers[i], 'g');
                let arabicRegex = new RegExp(arabicNumbers[i], 'g');
                output = output.replace(persianRegex, i).replace(arabicRegex, i);
            }
            
            return output;
        }

        // تابع تبدیل عدد به حروف فارسی
        function numberToWords(number) {
            if (number === 0) return "صفر";
            
            const ones = ["", "یک", "دو", "سه", "چهار", "پنج", "شش", "هفت", "هشت", "نه"];
            const tens = ["", "ده", "بیست", "سی", "چهل", "پنجاه", "شصت", "هفتاد", "هشتاد", "نود"];
            const hundreds = ["", "صد", "دویست", "سیصد", "چهارصد", "پانصد", "ششصد", "هفتصد", "هشتصد", "نهصد"];
            const teens = ["ده", "یازده", "دوازده", "سیزده", "چهارده", "پانزده", "شانزده", "هفده", "هجده", "نوزده"];
            
            let result = "";
            
            // میلیون‌ها
            if (number >= 1000000) {
                result += numberToWords(Math.floor(number / 1000000)) + " میلیون ";
                number %= 1000000;
            }
            
            // هزارها
            if (number >= 1000) {
                result += numberToWords(Math.floor(number / 1000)) + " هزار ";
                number %= 1000;
            }
            
            // صدها
            if (number >= 100) {
                result += hundreds[Math.floor(number / 100)] + " و ";
                number %= 100;
            }
            
            // دهگان و یکان
            if (number >= 10 && number < 20) {
                result += teens[number - 10];
            } else {
                if (number >= 20) {
                    result += tens[Math.floor(number / 10)];
                    number %= 10;
                    if (number > 0) result += " و ";
                }
                
                if (number > 0) {
                    result += ones[number];
                }
            }
            
            return result.trim().replace(/ و $/, "");
        }

        // تابع به‌روزرسانی مبلغ به حروف
        function updatePriceWords(input) {
            const value = parseInt(input.val()) || 0;
            const words = numberToWords(value);
            input.siblings('.price-words').text(words + " تومان");
        }

        // محاسبه جمع‌های فاکتور
        function calculateTotals() {
            let totalItems = 0;
            let totalAmount = 0;
            let totalDiscount = 0;
            
            $('.item-row').each(function() {
                const quantity = parseInt($(this).find('input[name="quantity[]"]').val()) || 0;
                const unitPrice = parseFloat($(this).find('input[name="unit_price[]"]').val()) || 0;
                const discount = parseFloat($(this).find('input[name="discount[]"]').val()) || 0;
                const lineTotal = quantity * unitPrice;
                
                // به‌روزرسانی جمع کل خط
                $(this).find('.line-total-input').val(lineTotal);
                updatePriceWords($(this).find('.line-total-input'));
                
                totalItems += quantity;
                totalAmount += lineTotal;
                totalDiscount += discount;
            });
            
            $('#total-items').text(totalItems);
            $('#total-amount').text(totalAmount.toLocaleString('fa-IR') + ' تومان');
            $('#total-discount').text(totalDiscount.toLocaleString('fa-IR') + ' تومان');
            $('#final-amount').text((totalAmount - totalDiscount).toLocaleString('fa-IR') + ' تومان');
        }

        // تابع برای نمایش پیام
        function showMessage(message, type) {
            const messageClass = type === 'error' ? 'error-message' : 'success-message';
            const icon = type === 'error' ? 'fa-exclamation-circle' : 'fa-check-circle';

            $('#messages').html(`
                <div class="${messageClass}">
                    <i class="fas ${icon}"></i> ${message}
                </div>
            `);

            if (type !== 'error') {
                setTimeout(() => {
                    $('#messages').empty();
                }, 5000);
            }
        }

        // جستجوی فاکتور برای ویرایش
        $('#edit-invoice-search').on('input', function() {
            const query = $(this).val().trim();
            const convertedQuery = convertPersianToEnglishNumbers(query);
            
            if (convertedQuery.length < 2) {
                $('#edit-invoice-search-results').hide().empty();
                return;
            }
            
            clearTimeout(invoiceSearchTimeout);
            invoiceSearchTimeout = setTimeout(function() {
                $.ajax({
                    url: "{% url 'search_invoices_for_edit' %}",
                    data: { q: convertedQuery },
                    dataType: 'json',
                    success: function(data) {
                        if (data.results && data.results.length > 0) {
                            let html = '';
                            data.results.forEach(invoice => {
                                html += `
                                    <div class="search-result-item" data-invoice-id="${invoice.id}">
                                        <strong>${invoice.serial_number}</strong>
                                        <div>فروشنده: ${invoice.seller_name}</div>
                                        <div>تاریخ: ${invoice.date}</div>
                                    </div>
                                `;
                            });
                            $('#edit-invoice-search-results').html(html).show();
                        } else {
                            $('#edit-invoice-search-results').html('<div class="search-result-item">هیچ فاکتوری یافت نشد</div>').show();
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error in invoice search for edit:', error);
                        showMessage('خطا در جستجوی فاکتورها', 'error');
                    }
                });
            }, 300);
        });

        // انتخاب فاکتور از نتایج جستجو
        $(document).on('click', '#edit-invoice-search-results .search-result-item', function() {
            const invoiceId = $(this).data('invoice-id');
            const invoiceText = $(this).find('strong').text();
            $('#edit-invoice-search').val(invoiceText);
            $('#edit-invoice-search-results').hide();

            // دریافت جزئیات فاکتور
            $.ajax({
                url: "{% url 'get_invoice_for_edit' %}",
                data: { invoice_id: invoiceId },
                dataType: 'json',
                success: function(data) {
                    if (data.success) {
                        editingInvoice = data.invoice;
                        editingInvoiceItems = data.items;

                        // نمایش اطلاعات فاکتور
                        $('#invoice-info').html(`
                            <div class="info-item"><strong>شماره فاکتور:</strong> ${editingInvoice.serial_number}</div>
                            <div class="info-item"><strong>فروشنده:</strong> ${editingInvoice.seller_name}</div>
                            <div class="info-item"><strong>تاریخ:</strong> ${editingInvoice.date}</div>
                            <input type="hidden" id="invoice-id" value="${editingInvoice.id}">
                        `);

                        // نمایش آیتم‌های فاکتور
                        updateInvoiceItemsList();

                        $('#invoice-details').show();
                    } else {
                        showMessage(data.error, 'error');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error getting invoice details:', error);
                    showMessage('خطا در دریافت اطلاعات فاکتور', 'error');
                }
            });
        });

        // به روزرسانی لیست آیتم‌های فاکتور
        function updateInvoiceItemsList() {
            const $itemsList = $('#invoice-items-list');
            $itemsList.empty();

            editingInvoiceItems.forEach((item, index) => {
                const row = `
                    <tr class="item-row" data-item-index="${index}">
                        <td>
                            <input type="text" class="product-name" name="product_name[]" value="${item.product_name}" required>
                        </td>
                        <td>
                            <input type="number" class="unit-price price-input" name="unit_price[]" value="${item.unit_price}" min="0" step="100" required>
                            <div class="price-words"></div>
                        </td>
                        <td>
                            <input type="number" name="quantity[]" value="${item.quantity}" min="1" required>
                        </td>
                        <td>
                            <input type="number" class="line-total-input" readonly>
                            <div class="price-words"></div>
                        </td>
                        <td>
                            <input type="number" name="discount[]" value="${item.discount}" min="0" step="100">
                        </td>
                        <td>
                            <button type="button" class="btn btn-danger remove-item" data-index="${index}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                $itemsList.append(row);
                
                // محاسبه اولیه برای این سطر
                const quantity = parseInt(item.quantity) || 0;
                const unitPrice = parseFloat(item.unit_price) || 0;
                const lineTotal = quantity * unitPrice;
                
                $itemsList.find('tr:last-child .line-total-input').val(lineTotal);
                updatePriceWords($itemsList.find('tr:last-child .line-total-input'));
                updatePriceWords($itemsList.find('tr:last-child .unit-price'));
            });

            calculateTotals();
        }

        // افزودن آیتم جدید
        $('#add-item-btn').click(function() {
            const newRow = `
                <tr class="item-row" data-item-index="${editingInvoiceItems.length}">
                    <td>
                        <input type="text" class="product-name" name="product_name[]" placeholder="نام کالا" required>
                    </td>
                    <td>
                        <input type="number" class="unit-price price-input" name="unit_price[]" min="0" step="100" value="0" required>
                        <div class="price-words"></div>
                    </td>
                    <td>
                        <input type="number" name="quantity[]" value="1" min="1" required>
                    </td>
                    <td>
                        <input type="number" class="line-total-input" readonly>
                        <div class="price-words"></div>
                    </td>
                    <td>
                        <input type="number" name="discount[]" value="0" min="0" step="100">
                    </td>
                    <td>
                        <button type="button" class="btn btn-danger remove-item" data-index="${editingInvoiceItems.length}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
            
            $('#invoice-items-list').append(newRow);
            editingInvoiceItems.push({
                product_name: '',
                quantity: 1,
                unit_price: 0,
                discount: 0
            });
            
            // افزودن رویداد برای محاسبه
            $('#invoice-items-list tr:last-child input').on('input', calculateTotals);
        });

        // حذف آیتم
        $(document).on('click', '.remove-item', function() {
            const index = $(this).data('index');
            if (editingInvoiceItems.length > 1) {
                $(this).closest('tr').remove();
                editingInvoiceItems.splice(index, 1);
                
                // به روزرسانی index برای همه سطرها
                $('.item-row').each(function(i) {
                    $(this).attr('data-item-index', i);
                    $(this).find('.remove-item').attr('data-index', i);
                });
                
                calculateTotals();
            } else {
                showMessage('حداقل یک کالا باید وجود داشته باشد', 'error');
            }
        });

        // محاسبه هنگام تغییر مقادیر
        $(document).on('input', 'input[name="quantity[]"], input[name="unit_price[]"], input[name="discount[]"]', function() {
            calculateTotals();
        });

        // ثبت تغییرات
        $('#edit-invoice-submit-btn').click(function() {
            if (!editingInvoice) {
                showMessage('لطفاً ابتدا یک فاکتور انتخاب کنید', 'error');
                return;
            }
            
            // جمع‌آوری داده‌های فرم
            const formData = {
                invoice_id: $('#invoice-id').val(),
                items: []
            };
            
            let isValid = true;
            
            $('.item-row').each(function() {
                const productName = $(this).find('input[name="product_name[]"]').val();
                const quantity = $(this).find('input[name="quantity[]"]').val();
                const unitPrice = $(this).find('input[name="unit_price[]"]').val();
                const discount = $(this).find('input[name="discount[]"]').val();
                
                if (!productName || !quantity || !unitPrice) {
                    isValid = false;
                    showMessage('لطفاً تمام فیلدهای ضروری را پر کنید', 'error');
                    return false;
                }
                
                formData.items.push({
                    product_name: productName,
                    quantity: quantity,
                    unit_price: unitPrice,
                    discount: discount || 0
                });
            });
            
            if (!isValid) return;
            
            // ارسال درخواست به سرور
            $.ajax({
                url: "{% url 'update_invoice' %}",
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                success: function(data) {
                    if (data.success) {
                        showMessage('فاکتور با موفقیت به روزرسانی شد', 'success');
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    } else {
                        showMessage(data.error, 'error');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error updating invoice:', error);
                    showMessage('خطا در به روزرسانی فاکتور', 'error');
                }
            });
        });

        // بازگشت
        $('#edit-invoice-back-btn').click(function() {
            if (confirm('تغییرات ذخیره نشده از بین خواهند رفت. آیا مطمئن هستید؟')) {
                window.location.href = "{% url 'home' %}";
            }
        });

        // مخفی کردن نتایج جستجو هنگام کلیک خارج
        $(document).on('click', function(e) {
            if (!$(e.target).closest('.search-container').length) {
                $('#edit-invoice-search-results').hide();
            }
        });
    </script>
</body>
</html>