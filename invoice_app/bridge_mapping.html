<!DOCTYPE html>
<html>
<head>
    <title>تنظیمات مپینگ پوز بریج</title>
    <style>
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: right; }
        th { background-color: #f2f2f2; }
        input[type="text"] { width: 150px; padding: 5px; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h2>🗺️ مدیریت مپینگ شعبه به سرویس واسط</h2>

    <form method="post">
        {% csrf_token %}
        <table>
            <thead>
                <tr>
                    <th>شناسه شعبه</th>
                    <th>نام شعبه</th>
                    <th>IP مودم شعبه</th>
                    <th>IP سرویس واسط</th>
                    <th>تست ارتباط</th>
                </tr>
            </thead>
            <tbody>
                {% for item in current_mapping %}
                <tr>
                    <td>{{ item.branch.id }}</td>
                    <td>{{ item.branch.name }}</td>
                    <td>{{ item.branch.modem_ip|default:"تعیین نشده" }}</td>
                    <td>
                        <input type="text"
                               name="branch_{{ item.branch.id }}"
                               value="{{ item.bridge_ip }}"
                               placeholder="192.168.1.100">
                    </td>
                    <td>
                        <button type="button" onclick="testConnection({{ item.branch.id }})">
                            تست ارتباط
                        </button>
                        <br>
                        <span id="status_{{ item.branch.id }}"></span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <button type="submit">💾 ذخیره تنظیمات</button>
    </form>

    <script>
    function testConnection(branchId) {
        const statusSpan = document.getElementById(`status_${branchId}`);
        statusSpan.innerHTML = '⏳ در حال تست...';

        fetch('/invoice/test-bridge-connection/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({branch_id: branchId})
        })
        .then(response => response.json())
        .then(data => {
            if(data.status === 'success') {
                statusSpan.innerHTML = '✅ سرویس فعال';
                statusSpan.style.color = 'green';
            } else {
                statusSpan.innerHTML = '❌ ' + data.message;
                statusSpan.style.color = 'red';
            }
        });
    }
    </script>
</body>
</html>